var croct=function(){"use strict";function e(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var n=function e(){if(this instanceof e){var n=[null];return n.push.apply(n,arguments),new(Function.bind.apply(t,n))}return t.apply(this,arguments)};n.prototype=t.prototype}else n={};return Object.defineProperty(n,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var r=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(n,t,r.get?r:{enumerable:!0,get:function(){return e[t]}})})),n}var t={},n={},r={},i=function(e,t){return i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},i(e,t)};var o=function(){return o=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},o.apply(this,arguments)};var s=Object.create?function(e,t,n,r){void 0===r&&(r=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,i)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]};function a(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function c(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(e){i={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function u(e){return this instanceof u?(this.v=e,this):new u(e)}var l=Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t};var d,h=Object.freeze({__proto__:null,get __assign(){return o},__asyncDelegator:function(e){var t,n;return t={},r("next"),r("throw",(function(e){throw e})),r("return"),t[Symbol.iterator]=function(){return this},t;function r(r,i){t[r]=e[r]?function(t){return(n=!n)?{value:u(e[r](t)),done:!1}:i?i(t):t}:i}},__asyncGenerator:function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,i=n.apply(e,t||[]),o=[];return r={},s("next"),s("throw"),s("return"),r[Symbol.asyncIterator]=function(){return this},r;function s(e){i[e]&&(r[e]=function(t){return new Promise((function(n,r){o.push([e,t,n,r])>1||a(e,t)}))})}function a(e,t){try{(n=i[e](t)).value instanceof u?Promise.resolve(n.value.v).then(c,l):d(o[0][2],n)}catch(e){d(o[0][3],e)}var n}function c(e){a("next",e)}function l(e){a("throw",e)}function d(e,t){e(t),o.shift(),o.length&&a(o[0][0],o[0][1])}},__asyncValues:function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e=a(e),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,i){(function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)})(r,i,(t=e[n](t)).done,t.value)}))}}},__await:u,__awaiter:function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))},__classPrivateFieldGet:function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)},__classPrivateFieldIn:function(e,t){if(null===t||"object"!=typeof t&&"function"!=typeof t)throw new TypeError("Cannot use 'in' operator on non-object");return"function"==typeof e?t===e:e.has(t)},__classPrivateFieldSet:function(e,t,n,r,i){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?i.call(e,n):i?i.value=n:t.set(e,n),n},__createBinding:s,__decorate:function(e,t,n,r){var i,o=arguments.length,s=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(i=e[a])&&(s=(o<3?i(s):o>3?i(t,n,s):i(t,n))||s);return o>3&&s&&Object.defineProperty(t,n,s),s},__esDecorate:function(e,t,n,r,i,o){function s(e){if(void 0!==e&&"function"!=typeof e)throw new TypeError("Function expected");return e}for(var a,c=r.kind,u="getter"===c?"get":"setter"===c?"set":"value",l=!t&&e?r.static?e:e.prototype:null,d=t||(l?Object.getOwnPropertyDescriptor(l,r.name):{}),h=!1,p=n.length-1;p>=0;p--){var g={};for(var y in r)g[y]="access"===y?{}:r[y];for(var y in r.access)g.access[y]=r.access[y];g.addInitializer=function(e){if(h)throw new TypeError("Cannot add initializers after decoration has completed");o.push(s(e||null))};var m=(0,n[p])("accessor"===c?{get:d.get,set:d.set}:d[u],g);if("accessor"===c){if(void 0===m)continue;if(null===m||"object"!=typeof m)throw new TypeError("Object expected");(a=s(m.get))&&(d.get=a),(a=s(m.set))&&(d.set=a),(a=s(m.init))&&i.push(a)}else(a=s(m))&&("field"===c?i.push(a):d[u]=a)}l&&Object.defineProperty(l,r.name,d),h=!0},__exportStar:function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||s(t,e,n)},__extends:function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)},__generator:function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(s=0)),s;)try{if(n=1,r&&(i=2&a[0]?r.return:a[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,a[1])).done)return i;switch(r=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],r=0}finally{n=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}},__importDefault:function(e){return e&&e.__esModule?e:{default:e}},__importStar:function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&s(t,e,n);return l(t,e),t},__makeTemplateObject:function(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e},__metadata:function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param:function(e,t){return function(n,r){t(n,r,e)}},__propKey:function(e){return"symbol"==typeof e?e:"".concat(e)},__read:c,__rest:function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n},__runInitializers:function(e,t,n){for(var r=arguments.length>2,i=0;i<t.length;i++)n=r?t[i].call(e,n):t[i].call(e);return r?n:void 0},__setFunctionName:function(e,t,n){return"symbol"==typeof t&&(t=t.description?"[".concat(t.description,"]"):""),Object.defineProperty(e,"name",{configurable:!0,value:n?"".concat(n," ",t):t})},__spread:function(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(c(arguments[t]));return e},__spreadArray:function(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))},__spreadArrays:function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),i=0;for(t=0;t<n;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r},__values:a}),p=e(h),g={},y={},m={};function f(){if(d)return m;d=1,Object.defineProperty(m,"__esModule",{value:!0}),m.Violation=void 0;class e extends Error{constructor(e,t,n){super(e),this.path=t,this.params=n}}return m.Violation=e,m}var v,b={};function w(){if(v)return b;return v=1,Object.defineProperty(b,"__esModule",{value:!0}),b.formatPath=b.describe=void 0,b.describe=function(e){return null===e?"null":Array.isArray(e)?"array":"number"==typeof e?Number.isInteger(e)?"integer":"number":"object"==typeof e?e.constructor.name:typeof e},b.formatPath=function(e){return`/${e.join("/")}`},b}var T,k={};var S,P={};var O,_={};var E,C={};var x,L={};function j(){if(x)return L;x=1,Object.defineProperty(L,"__esModule",{value:!0}),L.MixedSchema=void 0;return L.MixedSchema=class{validate(){}},L}var I,M={};var N,A={};var $,U={};var F,R={};var q,D,V={};function B(){if(D)return g;D=1,Object.defineProperty(g,"__esModule",{value:!0}),g.tokenScopeSchema=void 0;const e=y;return g.tokenScopeSchema=new e.StringType({enumeration:["global","contextual","isolated"]}),g}!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.UnionType=e.StringType=e.ObjectType=e.NumberType=e.NullType=e.MixedSchema=e.JsonPrimitiveType=e.JsonObjectType=e.JsonArrayType=e.JsonType=e.FunctionType=e.BooleanType=e.ArrayType=void 0;const t=p;t.__exportStar(f(),e),t.__exportStar(w(),e);var n=function(){if(T)return k;T=1,Object.defineProperty(k,"__esModule",{value:!0}),k.ArrayType=void 0;const e=f(),t=w();return k.ArrayType=class{constructor(e={}){var t,n;this.definition={...e,minItems:null!==(t=e.minItems)&&void 0!==t?t:-1,maxItems:null!==(n=e.maxItems)&&void 0!==n?n:-1}}getTypes(){return["array"]}isValidType(e){return Array.isArray(e)}validate(n,r=[]){if(!this.isValidType(n))throw new e.Violation(`Expected value of type array at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:"string"});const{minItems:i,maxItems:o}=this.definition,{length:s}=n;if(i>=0&&i>s)throw new e.Violation(`Expected ${i===o?"exactly":"at least"} ${i} ${1===i?"item":"items"} at path '${(0,t.formatPath)(r)}', actual ${s}.`,r,{limit:i});if(o>=0&&o<s)throw new e.Violation(`Expected ${i===o?"exactly":"at most"} ${o} ${1===o?"item":"items"} at path '${(0,t.formatPath)(r)}', actual ${s}.`,r,{limit:o});if(void 0!==this.definition.items)for(let e=0;e<s;e++)this.definition.items.validate(n[e],r.concat([e.toString()]))}},k}();Object.defineProperty(e,"ArrayType",{enumerable:!0,get:function(){return n.ArrayType}});var r=function(){if(S)return P;S=1,Object.defineProperty(P,"__esModule",{value:!0}),P.BooleanType=void 0;const e=f(),t=w();return P.BooleanType=class{getTypes(){return["boolean"]}isValidType(e){return"boolean"==typeof e}validate(n,r=[]){if(!this.isValidType(n))throw new e.Violation(`Expected value of type boolean at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:"boolean"})}},P}();Object.defineProperty(e,"BooleanType",{enumerable:!0,get:function(){return r.BooleanType}});var i=function(){if(O)return _;O=1,Object.defineProperty(_,"__esModule",{value:!0}),_.FunctionType=void 0;const e=f(),t=w();return _.FunctionType=class{getTypes(){return["function"]}isValidType(e){return"function"==typeof e}validate(n,r=[]){if(!this.isValidType(n))throw new e.Violation(`Expected value of type function at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:"function"})}},_}();Object.defineProperty(e,"FunctionType",{enumerable:!0,get:function(){return i.FunctionType}});var o=function(){if(E)return C;E=1,Object.defineProperty(C,"__esModule",{value:!0}),C.JsonType=C.JsonPrimitiveType=C.JsonArrayType=C.JsonObjectType=void 0;const e=f(),t=w();function n(e){return null===e||"string"==typeof e||"boolean"==typeof e||"number"==typeof e}function r(e){return"[object Object]"===Object.prototype.toString.call(e)}function i(e){return Array.isArray(e)&&e.every(s)}function o(e){return r(e)&&Object.values(e).every(s)}function s(e){return n(e)||i(e)||o(e)}return C.JsonObjectType=class{constructor(e={}){this.definition=e}getTypes(){return["object"]}isValidType(e){return r(e)}validate(n,r=[]){if(!o(n))throw new e.Violation(`Expected a JSON object at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:"object"});if(void 0!==this.definition.properties||void 0!==this.definition.propertyNames)for(const[e,t]of Object.entries(n)){const n=r.concat([e]);void 0!==this.definition.propertyNames&&this.definition.propertyNames.validate(e,n),void 0!==this.definition.properties&&this.definition.properties.validate(t,r.concat([e]))}}},C.JsonArrayType=class{constructor(e={}){this.definition=e}getTypes(){return["array"]}isValidType(e){return Array.isArray(e)}validate(n,r=[]){if(!i(n))throw new e.Violation(`Expected a JSON array at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:"array"});if(void 0!==this.definition.items)for(let e=0;e<n.length;e++)this.definition.items.validate(n[e],r.concat([e.toString()]))}},C.JsonPrimitiveType=class{getTypes(){return["null","number","string","boolean"]}isValidType(e){return n(e)}validate(n,r=[]){if(!this.isValidType(n))throw new e.Violation(`Expected a JSON primitive at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:this.getTypes().join("|")})}},C.JsonType=class{getTypes(){return["null","number","string","boolean","array","object"]}isValidType(e){return n(e)||Array.isArray(e)||r(e)}validate(n,r=[]){if(!s(n))throw new e.Violation(`Expected a JSON value at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:this.getTypes().join("|")})}},C}();Object.defineProperty(e,"JsonType",{enumerable:!0,get:function(){return o.JsonType}}),Object.defineProperty(e,"JsonArrayType",{enumerable:!0,get:function(){return o.JsonArrayType}}),Object.defineProperty(e,"JsonObjectType",{enumerable:!0,get:function(){return o.JsonObjectType}}),Object.defineProperty(e,"JsonPrimitiveType",{enumerable:!0,get:function(){return o.JsonPrimitiveType}});var s=j();Object.defineProperty(e,"MixedSchema",{enumerable:!0,get:function(){return s.MixedSchema}});var a=function(){if(I)return M;I=1,Object.defineProperty(M,"__esModule",{value:!0}),M.NullType=void 0;const e=f(),t=w();return M.NullType=class{getTypes(){return["null"]}isValidType(e){return null===e}validate(n,r=[]){if(!this.isValidType(n))throw new e.Violation(`Expected value of type null at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:"null"})}},M}();Object.defineProperty(e,"NullType",{enumerable:!0,get:function(){return a.NullType}});var c=function(){if(N)return A;N=1,Object.defineProperty(A,"__esModule",{value:!0}),A.NumberType=void 0;const e=f(),t=w();return A.NumberType=class{constructor(e={}){var t,n,r;this.definition={...e,integer:null!==(t=e.integer)&&void 0!==t&&t,minimum:null!==(n=e.minimum)&&void 0!==n?n:Number.NEGATIVE_INFINITY,maximum:null!==(r=e.maximum)&&void 0!==r?r:Number.POSITIVE_INFINITY}}getTypes(){return[this.definition.integer?"integer":"number"]}isValidType(e){return"number"==typeof e&&(!this.definition.integer||Number.isInteger(e))}validate(n,r=[]){if(!this.isValidType(n)){const i=this.getTypes()[0];throw new e.Violation(`Expected value of type ${i} at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:i})}if(n<this.definition.minimum)throw new e.Violation(`Expected a value greater than or equal to ${this.definition.minimum} at path '${(0,t.formatPath)(r)}', actual ${n}.`,r,{limit:this.definition.minimum});if(n>this.definition.maximum)throw new e.Violation(`Expected a value less than or equal to ${this.definition.maximum} at path '${(0,t.formatPath)(r)}', actual ${n}.`,r,{limit:this.definition.maximum})}},A}();Object.defineProperty(e,"NumberType",{enumerable:!0,get:function(){return c.NumberType}});var u=function(){if($)return U;$=1,Object.defineProperty(U,"__esModule",{value:!0}),U.ObjectType=void 0;const e=f(),t=j(),n=w();return U.ObjectType=class{constructor(e={}){var n,r,i,o,s,a;this.definition={...e,properties:null!==(n=e.properties)&&void 0!==n?n:{},required:null!==(r=e.required)&&void 0!==r?r:[],additionalProperties:null!==(i=e.additionalProperties)&&void 0!==i&&i,propertyNames:null!==(o=e.propertyNames)&&void 0!==o?o:new t.MixedSchema,minProperties:null!==(s=e.minProperties)&&void 0!==s?s:-1,maxProperties:null!==(a=e.maxProperties)&&void 0!==a?a:-1}}getTypes(){return void 0!==this.definition.type?[this.definition.type.name]:["object"]}isValidType(e){return void 0!==this.definition.type?e instanceof this.definition.type:"[object Object]"===Object.prototype.toString.call(e)}validate(t,r=[]){if(!this.isValidType(t)){const[i]=this.getTypes();throw new e.Violation(`Expected value of type ${i} at path '${(0,n.formatPath)(r)}', actual ${(0,n.describe)(t)}.`,r,{type:i})}const i=Object.entries(t),{minProperties:o,maxProperties:s}=this.definition;if(o>=0&&o>i.length)throw new e.Violation(`Expected ${o===s?"exactly":"at least"} ${o} ${1===o?"entry":"entries"} at path '${(0,n.formatPath)(r)}', actual ${i.length}.`,r,{limit:o});if(s>=0&&s<i.length)throw new e.Violation(`Expected ${o===s?"exactly":"at most"} ${s} ${1===s?"entry":"entries"} at path '${(0,n.formatPath)(r)}', actual ${i.length}.`,r,{limit:s});const a={...t};for(const i of this.definition.required)if(!(i in t))throw new e.Violation(`Missing property '${(0,n.formatPath)(r.concat([i]))}'.`,r,{required:i});for(const[t,o]of i){const i=r.concat([t]);this.definition.propertyNames.validate(t,i);const s=this.definition.properties[t];if(void 0===s){if(!1===this.definition.additionalProperties)throw new e.Violation(`Unknown property '${(0,n.formatPath)(i)}'.`,i,{additionalProperty:t});!0!==this.definition.additionalProperties&&this.definition.additionalProperties.validate(o,i)}else s.validate(o,i),delete a[t]}const{subtypes:c}=this.definition;if(void 0!==c){const e=t[c.discriminator];void 0!==e&&void 0!==c.schemas[e]&&c.schemas[e].validate(a,r)}}},U}();Object.defineProperty(e,"ObjectType",{enumerable:!0,get:function(){return u.ObjectType}});var l=function(){if(F)return R;F=1,Object.defineProperty(R,"__esModule",{value:!0}),R.StringType=void 0;const e=f(),t=w(),n={pointer:function(e){return/^(\.|([a-zA-Z_][a-zA-Z0-9_]*|\[[0-9]+])(\.[a-zA-Z_][a-zA-Z0-9_]*|\[[0-9]+])*)$/.test(e)},identifier:function(e){return/^[a-zA-Z_][a-zA-Z0-9_]*$/.test(e)},uuid:function(e){return/^[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/.test(e)},date:function(e){return/^(\d\d\d\d)-(\d\d)-(\d\d)$/.test(e)},url:function(e){try{new URL(e)}catch{return!1}return!0}};return R.StringType=class{constructor(e={}){var t,n,r;this.definition={...e,minLength:null!==(t=e.minLength)&&void 0!==t?t:-1,maxLength:null!==(n=e.maxLength)&&void 0!==n?n:-1,enumeration:null!==(r=e.enumeration)&&void 0!==r?r:[]}}getTypes(){return["string"]}isValidType(e){return"string"==typeof e}validate(r,i=[]){if(!this.isValidType(r))throw new e.Violation(`Expected value of type string at path '${(0,t.formatPath)(i)}', actual ${(0,t.describe)(r)}.`,i,{type:"string"});const{minLength:o,maxLength:s}=this.definition;if(o>=0&&o>r.length)throw new e.Violation(`Expected ${o===s?"exactly":"at least"} ${o} ${1===o?"character":"characters"} at path '${(0,t.formatPath)(i)}', actual ${r.length}.`,i,{limit:o});if(s>=0&&s<r.length)throw new e.Violation(`Expected ${o===s?"exactly":"at most"} ${s} ${1===s?"character":"characters"} at path '${(0,t.formatPath)(i)}', actual ${r.length}.`,i,{limit:s});const{enumeration:a}=this.definition;if(a.length>0&&a.indexOf(r)<0)throw new e.Violation(`Unexpected value at path '${(0,t.formatPath)(i)}', expecting '${1===a.length?a[0]:`${a.slice(0,-1).join("', '")}' or '${a.slice(-1)}`}', found '${r}'.`,i,{enumeration:a});const{format:c,pattern:u}=this.definition;if(void 0!==c&&!n[c](r))throw new e.Violation(`Invalid ${c} format at path '${(0,t.formatPath)(i)}'.`,i,{format:c});if(void 0!==u&&!u.test(r))throw new e.Violation(`Invalid format at path '${(0,t.formatPath)(i)}'.`,i,{pattern:u})}},R}();Object.defineProperty(e,"StringType",{enumerable:!0,get:function(){return l.StringType}});var d=function(){if(q)return V;q=1,Object.defineProperty(V,"__esModule",{value:!0}),V.UnionType=void 0;const e=f(),t=w();return V.UnionType=class{constructor(e,t,...n){this.schemas=[e,t,...n]}getTypes(){const e=[];for(const t of this.schemas)for(const n of t.getTypes())e.indexOf(n)<0&&e.push(n);return e}isValidType(e){for(const t of this.schemas)if(t.isValidType(e))return!0;return!1}validate(n,r=[]){for(const e of this.schemas)if(e.isValidType(n))return void e.validate(n,r);const i=this.getTypes();throw new e.Violation(`Expected value of type ${i.slice(0,-1).join(", ")} or ${i[i.length-1]} at path '${(0,t.formatPath)(r)}', actual ${(0,t.describe)(n)}.`,r,{type:i.join("|")})}},V}();Object.defineProperty(e,"UnionType",{enumerable:!0,get:function(){return d.UnionType}})}(y);var z,Q={};function J(){return z||(z=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.order=e.orderItem=e.cart=e.cartItem=e.productDetails=void 0;const t=y;e.productDetails=new t.ObjectType({required:["productId","name","displayPrice"],properties:{productId:new t.StringType({minLength:1,maxLength:50}),sku:new t.StringType({minLength:1,maxLength:50}),name:new t.StringType({minLength:1,maxLength:200}),category:new t.StringType({minLength:1,maxLength:100}),brand:new t.StringType({minLength:1,maxLength:100}),variant:new t.StringType({minLength:1,maxLength:50}),displayPrice:new t.NumberType({minimum:0}),originalPrice:new t.NumberType({minimum:0}),url:new t.StringType({format:"url"}),imageUrl:new t.StringType({format:"url"})}}),e.cartItem=new t.ObjectType({required:["index","product","quantity","total"],properties:{index:new t.NumberType({minimum:0}),product:e.productDetails,quantity:new t.NumberType({minimum:1}),total:new t.NumberType({minimum:0}),discount:new t.NumberType({minimum:0}),coupon:new t.StringType({minLength:1,maxLength:50})}}),e.cart=new t.ObjectType({required:["currency","items","total"],properties:{currency:new t.StringType({maxLength:10,minLength:1}),items:new t.ArrayType({items:e.cartItem}),subtotal:new t.NumberType({minimum:0}),shippingPrice:new t.NumberType({minimum:0}),taxes:new t.ObjectType({additionalProperties:new t.NumberType,minProperties:1}),costs:new t.ObjectType({additionalProperties:new t.NumberType,minProperties:1}),discount:new t.NumberType({minimum:0}),total:new t.NumberType({minimum:0}),coupon:new t.StringType({minLength:1,maxLength:50}),lastUpdateTime:new t.NumberType}}),e.orderItem=new t.ObjectType({required:["index","product","quantity","total"],properties:{index:new t.NumberType({minimum:0}),product:e.productDetails,quantity:new t.NumberType({minimum:1}),total:new t.NumberType({minimum:0}),discount:new t.NumberType({minimum:0}),coupon:new t.StringType({minLength:1,maxLength:50})}}),e.order=new t.ObjectType({required:["orderId","currency","items","total"],properties:{orderId:new t.StringType({minLength:1,maxLength:50}),currency:new t.StringType({maxLength:10,minLength:1}),items:new t.ArrayType({items:e.orderItem,minItems:1}),subtotal:new t.NumberType({minimum:0}),shippingPrice:new t.NumberType({minimum:0}),taxes:new t.ObjectType({additionalProperties:new t.NumberType,minProperties:1}),costs:new t.ObjectType({additionalProperties:new t.NumberType,minProperties:1}),discount:new t.NumberType({minimum:0}),total:new t.NumberType({minimum:0}),coupon:new t.StringType({minLength:1,maxLength:50}),paymentMethod:new t.StringType({minLength:1,maxLength:50}),installments:new t.NumberType({minimum:1}),status:new t.StringType({enumeration:["placed","paid","complete"]})}})}(Q)),Q}var X,G={};var K,W={};var Y,Z,H={},ee={},te={};function ne(){if(Y)return te;Y=1,Object.defineProperty(te,"__esModule",{value:!0}),te.attributeNameSchema=void 0;const e=y;return te.attributeNameSchema=new e.StringType({maxLength:50,format:"identifier"}),te}function re(){if(Z)return ee;Z=1,Object.defineProperty(ee,"__esModule",{value:!0}),ee.userProfileSchema=void 0;const e=y,t=ne();return ee.userProfileSchema=new e.ObjectType({properties:{firstName:new e.StringType({minLength:1,maxLength:50}),lastName:new e.StringType({minLength:1,maxLength:50}),birthDate:new e.StringType({format:"date"}),gender:new e.StringType({enumeration:["male","female","neutral","unknown"]}),email:new e.StringType({minLength:1,maxLength:254}),alternateEmail:new e.StringType({minLength:1,maxLength:254}),phone:new e.StringType({minLength:1,maxLength:30}),alternatePhone:new e.StringType({minLength:1,maxLength:30}),address:new e.ObjectType({properties:{street:new e.StringType({minLength:1,maxLength:100}),district:new e.StringType({minLength:1,maxLength:100}),city:new e.StringType({minLength:1,maxLength:100}),region:new e.StringType({minLength:1,maxLength:100}),country:new e.StringType({minLength:1,maxLength:100}),postalCode:new e.StringType({minLength:1,maxLength:20})}}),avatar:new e.StringType({maxLength:500,format:"url"}),company:new e.StringType({minLength:1,maxLength:200}),companyUrl:new e.StringType({maxLength:200,format:"url"}),jobTitle:new e.StringType({minLength:1,maxLength:50}),interests:new e.ArrayType({maxItems:30,items:new e.StringType({minLength:1,maxLength:30})}),activities:new e.ArrayType({maxItems:30,items:new e.StringType({minLength:1,maxLength:30})}),custom:new e.ObjectType({propertyNames:t.attributeNameSchema,maxProperties:10,additionalProperties:new e.UnionType(new e.BooleanType,new e.NullType,new e.NumberType,new e.StringType({maxLength:100}),new e.ArrayType({maxItems:10,items:new e.UnionType(new e.BooleanType,new e.NullType,new e.NumberType,new e.StringType({maxLength:100}),new e.ArrayType({maxItems:10,items:new e.UnionType(new e.BooleanType,new e.NullType,new e.NumberType,new e.StringType({maxLength:100}))}),new e.ObjectType({propertyNames:t.attributeNameSchema,maxProperties:10,additionalProperties:new e.UnionType(new e.BooleanType,new e.NullType,new e.NumberType,new e.StringType({maxLength:100}))}))}),new e.ObjectType({propertyNames:t.attributeNameSchema,maxProperties:10,additionalProperties:new e.UnionType(new e.BooleanType,new e.NullType,new e.NumberType,new e.StringType({maxLength:100}),new e.ArrayType({maxItems:10,items:new e.UnionType(new e.BooleanType,new e.NullType,new e.NumberType,new e.StringType({maxLength:100}))}),new e.ObjectType({propertyNames:t.attributeNameSchema,maxProperties:10,additionalProperties:new e.UnionType(new e.BooleanType,new e.NullType,new e.NumberType,new e.StringType({maxLength:100}))}))}))})}}),ee}var ie,oe,se={};function ae(){if(oe)return H;oe=1,Object.defineProperty(H,"__esModule",{value:!0}),H.eventOccurred=H.linkOpened=H.postViewed=H.interestShown=H.goalCompleted=H.userSignedUp=H.productViewed=H.orderPlaced=H.checkoutStarted=H.cartViewed=H.cartModified=void 0;const e=y,t=J(),n=re(),r=function(){if(ie)return se;ie=1,Object.defineProperty(se,"__esModule",{value:!0}),se.postDetails=void 0;const e=y;return se.postDetails=new e.ObjectType({required:["postId","title","publishTime"],properties:{postId:new e.StringType({minLength:1,maxLength:200}),url:new e.StringType({format:"url"}),title:new e.StringType({minLength:1,maxLength:200}),tags:new e.ArrayType({items:new e.StringType({minLength:1,maxLength:50}),minItems:1,maxItems:10}),categories:new e.ArrayType({items:new e.StringType({minLength:1,maxLength:50}),minItems:1,maxItems:10}),authors:new e.ArrayType({items:new e.StringType({minLength:1,maxLength:50}),minItems:1,maxItems:10}),publishTime:new e.NumberType,updateTime:new e.NumberType}}),se}();return H.cartModified=new e.ObjectType({required:["cart"],properties:{cart:t.cart}}),H.cartViewed=new e.ObjectType({required:["cart"],properties:{cart:t.cart}}),H.checkoutStarted=new e.ObjectType({required:["cart"],properties:{cart:t.cart,orderId:new e.StringType({minLength:1,maxLength:50})}}),H.orderPlaced=new e.ObjectType({required:["order"],properties:{order:t.order}}),H.productViewed=new e.ObjectType({required:["product"],properties:{product:t.productDetails}}),H.userSignedUp=new e.ObjectType({required:["userId"],properties:{userId:new e.StringType({minLength:1,maxLength:254}),profile:n.userProfileSchema}}),H.goalCompleted=new e.ObjectType({required:["goalId"],properties:{goalId:new e.StringType({minLength:3,maxLength:100,pattern:/^[a-z0-9][a-z0-9:_-]+[a-z0-9]$/i}),value:new e.NumberType({minimum:0}),currency:new e.StringType({minLength:1,maxLength:10})}}),H.interestShown=new e.ObjectType({required:["interests"],properties:{interests:new e.ArrayType({items:new e.StringType({minLength:1,maxLength:50}),minItems:1,maxItems:10})}}),H.postViewed=new e.ObjectType({required:["post"],properties:{post:r.postDetails}}),H.linkOpened=new e.ObjectType({required:["link"],properties:{link:new e.StringType}}),H.eventOccurred=new e.ObjectType({required:["name"],properties:{name:new e.StringType({minLength:1,maxLength:50}),testId:new e.StringType({minLength:1,maxLength:50}),groupId:new e.StringType({minLength:1,maxLength:50}),personalizationId:new e.StringType({minLength:1,maxLength:50}),audience:new e.StringType({minLength:1,maxLength:50}),details:new e.ObjectType({additionalProperties:new e.UnionType(new e.NullType,new e.BooleanType,new e.NumberType,new e.StringType({maxLength:300})),propertyNames:new e.StringType({minLength:1,maxLength:20,format:"identifier"}),maxProperties:10})}}),H}var ce,ue={};function le(){if(ce)return ue;ce=1,Object.defineProperty(ue,"__esModule",{value:!0}),ue.loggerSchema=void 0;const e=y;return ue.loggerSchema=new e.ObjectType({required:["debug","info","warn","error"],additionalProperties:!0,properties:{debug:new e.FunctionType,info:new e.FunctionType,warn:new e.FunctionType,error:new e.FunctionType}}),ue}var de,he={};var pe,ge,ye={},me={};function fe(){return pe||(pe=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.sdkConfigurationSchema=e.eventMetadataSchema=void 0;const t=y,n=B(),r=le();e.eventMetadataSchema=new t.ObjectType({maxProperties:5,propertyNames:new t.StringType({minLength:1,maxLength:20,format:"identifier"}),additionalProperties:new t.StringType({maxLength:300})}),e.sdkConfigurationSchema=new t.ObjectType({required:["appId","tokenScope","disableCidMirroring","debug","test"],properties:{appId:new t.StringType({format:"uuid"}),clientId:new t.StringType({pattern:/^[0-9a-f]{32}$/i}),tokenScope:n.tokenScopeSchema,baseEndpointUrl:new t.StringType({format:"url"}),cidAssignerEndpointUrl:new t.StringType({format:"url"}),beaconQueueSize:new t.NumberType({minimum:0,integer:!0}),disableCidMirroring:new t.BooleanType,debug:new t.BooleanType,test:new t.BooleanType,logger:r.loggerSchema,urlSanitizer:new t.FunctionType,eventMetadata:e.eventMetadataSchema}})}(me)),me}var ve,be={};!function(e){Object.defineProperty(e,"__esModule",{value:!0});const t=p;t.__exportStar(B(),e),t.__exportStar(J(),e),t.__exportStar(function(){if(X)return G;X=1,Object.defineProperty(G,"__esModule",{value:!0}),G.evaluationOptionsSchema=void 0;const e=y;return G.evaluationOptionsSchema=new e.ObjectType({properties:{timeout:new e.NumberType({integer:!0,minimum:0}),attributes:new e.JsonObjectType}}),G}(),e),t.__exportStar(function(){if(K)return W;K=1,Object.defineProperty(W,"__esModule",{value:!0}),W.fetchOptionsSchema=void 0;const e=y;return W.fetchOptionsSchema=new e.ObjectType({properties:{timeout:new e.NumberType({integer:!0,minimum:0}),version:new e.UnionType(new e.StringType({pattern:/^\d+$/}),new e.NumberType({integer:!0,minimum:1})),preferredLocale:new e.StringType({pattern:/^[a-z]{2,3}([-_][a-z]{2,3})?$/i}),attributes:new e.JsonObjectType}}),W}(),e),t.__exportStar(ae(),e),t.__exportStar(le(),e),t.__exportStar(function(){if(de)return he;de=1,Object.defineProperty(he,"__esModule",{value:!0}),he.removeOperation=he.unsetOperation=he.clearOperation=he.incrementOperation=he.decrementOperation=he.mergeOperation=he.combineOperation=he.setOperation=he.addOperation=void 0;const e=y,t=ne(),n=new e.StringType({format:"pointer"}),r=new e.JsonArrayType({items:new e.JsonPrimitiveType}),i=new e.JsonObjectType({properties:new e.JsonPrimitiveType,propertyNames:t.attributeNameSchema}),o=new e.JsonObjectType({properties:new e.UnionType(new e.JsonPrimitiveType,r,i),propertyNames:t.attributeNameSchema}),s=new e.UnionType(r,o),a=new e.UnionType(new e.JsonPrimitiveType,r,o);return he.addOperation=new e.ObjectType({required:["path","value"],properties:{path:n,value:a}}),he.setOperation=new e.ObjectType({required:["path","value"],properties:{path:n,value:a}}),he.combineOperation=new e.ObjectType({required:["path","value"],properties:{path:n,value:a}}),he.mergeOperation=new e.ObjectType({required:["path","value"],properties:{path:n,value:s}}),he.decrementOperation=new e.ObjectType({required:["path","value"],properties:{path:n,value:new e.NumberType}}),he.incrementOperation=new e.ObjectType({required:["path","value"],properties:{path:n,value:new e.NumberType}}),he.clearOperation=new e.ObjectType({required:["path"],properties:{path:n}}),he.unsetOperation=new e.ObjectType({required:["path"],properties:{path:n}}),he.removeOperation=new e.ObjectType({required:["path","value"],properties:{path:n,value:a}}),he}(),e),t.__exportStar(function(){if(ge)return ye;ge=1,Object.defineProperty(ye,"__esModule",{value:!0}),ye.sdkFacadeConfigurationSchema=void 0;const e=y,t=B(),n=fe(),r=le();return ye.sdkFacadeConfigurationSchema=new e.ObjectType({required:["appId"],properties:{appId:new e.StringType({format:"uuid"}),clientId:new e.StringType({pattern:/^[0-9a-f]{32}$/i}),tokenScope:t.tokenScopeSchema,disableCidMirroring:new e.BooleanType,debug:new e.BooleanType,test:new e.BooleanType,track:new e.BooleanType,logger:r.loggerSchema,urlSanitizer:new e.FunctionType,eventMetadata:n.eventMetadataSchema,userId:new e.UnionType(new e.StringType({minLength:1}),new e.NullType),token:new e.UnionType(new e.StringType({pattern:/^[A-Za-z0-9-_=]+\.[A-Za-z0-9-_=]+\.?[A-Za-z0-9-_.+/=]*$/}),new e.NullType),baseEndpointUrl:new e.StringType({format:"url"}),cidAssignerEndpointUrl:new e.StringType({format:"url"})}}),ye}(),e),t.__exportStar(fe(),e),t.__exportStar(function(){if(ve)return be;ve=1,Object.defineProperty(be,"__esModule",{value:!0}),be.tokenSchema=void 0;const e=y;return be.tokenSchema=new e.ObjectType({required:["headers","payload"],properties:{headers:new e.ObjectType({required:["typ","alg"],properties:{typ:new e.StringType,alg:new e.StringType,kid:new e.StringType,appId:new e.StringType({format:"uuid"})}}),payload:new e.ObjectType({required:["iss","aud","iat"],properties:{iss:new e.StringType,aud:new e.UnionType(new e.StringType,new e.ArrayType({items:new e.StringType})),iat:new e.NumberType({minimum:0}),sub:new e.StringType({minLength:1}),exp:new e.NumberType({minimum:0}),jti:new e.StringType({format:"uuid"})},additionalProperties:!0}),signature:new e.StringType}}),be}(),e),t.__exportStar(re(),e)}(r);var we={};Object.defineProperty(we,"__esModule",{value:!0});var Te=we.formatCause=we.formatMessage=void 0;function ke(e){const t=function(e){return e instanceof Error?e.message:"string"==typeof e&&""!==e?e:"unknown error"}(e);return 0===t.length?t:t.charAt(0).toUpperCase()+t.slice(1)}we.formatMessage=ke,Te=we.formatCause=function(e){const t=ke(e);return 0===t.length?t:t.charAt(0).toLowerCase()+t.slice(1)},Object.defineProperty(n,"__esModule",{value:!0});var Se=n.TabContextFactory=n.MinimalContextFactory=n.EvaluatorFacade=void 0;const Pe=r,Oe=we;n.EvaluatorFacade=class{constructor(e){this.evaluator=e.evaluator,this.contextFactory=e.contextFactory,this.tokenProvider=e.userTokenProvider,this.cidAssigner=e.cidAssigner}async evaluate(e,t={}){var n;if("string"!=typeof e||0===e.length)throw new Error("The query must be a non-empty string.");return function(e){try{Pe.evaluationOptionsSchema.validate(e)}catch(e){throw new Error(`Invalid options: ${(0,Oe.formatCause)(e)}`)}}(t),this.evaluator.evaluate(e,{clientId:await this.cidAssigner.assignCid(),userToken:null!==(n=this.tokenProvider.getToken())&&void 0!==n?n:void 0,timeout:t.timeout,context:this.contextFactory.createContext(t.attributes)})}};n.MinimalContextFactory=class{createContext(e){return void 0===e?{}:{attributes:e}}};Se=n.TabContextFactory=class{constructor(e){this.tab=e}createContext(e){var t;const n=new URL(this.tab.url),r={},i={title:this.tab.title,url:n.toString()},{referrer:o}=this.tab;o.length>0&&(i.referrer=o),r.page=i;const s=null!==(t=Intl.DateTimeFormat().resolvedOptions().timeZone)&&void 0!==t?t:null;return null!==s&&(r.timeZone=s),void 0!==e&&Object.keys(e).length>0&&(r.attributes=e),r}};var _e={};Object.defineProperty(_e,"__esModule",{value:!0}),_e.TrackerFacade=void 0;const Ee=we,Ce=r,xe={cartViewed:Ce.cartViewed,cartModified:Ce.cartModified,checkoutStarted:Ce.checkoutStarted,orderPlaced:Ce.orderPlaced,productViewed:Ce.productViewed,userSignedUp:Ce.userSignedUp,eventOccurred:Ce.eventOccurred,interestShown:Ce.interestShown,postViewed:Ce.postViewed,goalCompleted:Ce.goalCompleted,linkOpened:Ce.linkOpened};function Le(e,t){if("string"!=typeof e)throw new Error("The event type must of type string.");if("object"!=typeof t||null==t)throw new Error("The event payload must of type object.");const n={type:e,...t};return function(e){const{type:t,...n}=e;if(!(t in xe))throw new Error(`Unknown event type '${t}'.`);try{xe[t].validate(n)}catch(e){throw new Error(`Invalid event payload: ${(0,Ee.formatCause)(e)}`)}}(n),n}_e.TrackerFacade=class{constructor(e){this.tracker=e}get flushed(){return this.tracker.flushed}enable(){this.tracker.enable()}disable(){this.tracker.disable()}addListener(e){this.tracker.addListener(e)}removeListener(e){this.tracker.removeListener(e)}track(e,t){return this.tracker.track(Le(e,t))}};var je={},Ie={},Me={};Object.defineProperty(Me,"__esModule",{value:!0}),Me.ActiveRecord=void 0;const Ne=r,Ae={add:Ne.addOperation,set:Ne.setOperation,merge:Ne.mergeOperation,combine:Ne.combineOperation,increment:Ne.incrementOperation,decrement:Ne.decrementOperation,clear:Ne.clearOperation,unset:Ne.unsetOperation,remove:Ne.removeOperation};Me.ActiveRecord=class{constructor(){this.operations=[]}set(e,t){return"string"==typeof e?this.pushOperation({type:"set",path:e,value:t}):this.pushOperation({type:"set",path:".",value:e})}add(e,t){return this.pushOperation({type:"add",path:e,value:t})}combine(e,t){return this.pushOperation({type:"combine",path:e,value:t})}merge(e,t){return"string"==typeof e?this.pushOperation({type:"merge",path:e,value:t}):this.pushOperation({type:"merge",path:".",value:e})}increment(e,t=1){return this.pushOperation({type:"increment",path:e,value:t})}decrement(e,t=1){return this.pushOperation({type:"decrement",path:e,value:t})}clear(e){return this.pushOperation({type:"clear",path:e})}unset(e){return this.pushOperation({type:"unset",path:e})}remove(e,t){return this.pushOperation({type:"remove",path:e,value:t})}pushOperation(e){const{type:t,...n}=e;return Ae[t].validate(n),this.operations.push(e),this}reset(){return this.operations.splice(0),this}isDirty(){return this.operations.length>0}buildPatch(){return{operations:this.operations.slice()}}},Object.defineProperty(Ie,"__esModule",{value:!0}),Ie.UserPatch=void 0;const $e=Me;class Ue extends $e.ActiveRecord{constructor(e){super(),this.tracker=e}save(){if(!this.isDirty())return Promise.resolve({type:"userProfileChanged",patch:{operations:[]}});const e=this.tracker.track({type:"userProfileChanged",patch:this.buildPatch()});return this.reset(),e}}Ie.UserPatch=Ue,Object.defineProperty(je,"__esModule",{value:!0}),je.UserFacade=void 0;const Fe=Ie;je.UserFacade=class{constructor(e,t){this.context=e,this.tracker=t}isIdentified(){return!this.isAnonymous()}isAnonymous(){return this.context.isAnonymous()}edit(){return new Fe.UserPatch(this.tracker)}};var Re,qe,De={},Ve={},Be={};function ze(){if(qe)return Ve;qe=1,Object.defineProperty(Ve,"__esModule",{value:!0}),Ve.FixedTokenProvider=Ve.Token=void 0;const e=function(){if(Re)return Be;function e(e){return(e+"===".slice((e.length+3)%4)).replace(/-/g,"+").replace(/_/g,"/")}function t(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}return Re=1,Object.defineProperty(Be,"__esModule",{value:!0}),Be.base64UrlDecode=Be.base64UrlEncode=void 0,Be.base64UrlEncode=function(e,n=!1){return t(n?window.btoa(window.encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,((e,t)=>String.fromCharCode(Number.parseInt(t,16))))):window.btoa(e))},Be.base64UrlDecode=function(t,n=!1){return n?window.decodeURIComponent(Array.prototype.map.call(window.atob(e(t)),(e=>`%${`00${e.charCodeAt(0).toString(16)}`.slice(-2)}`)).join("")):window.atob(e(t))},Be}(),t=r,n=we;class i{constructor(e,t,n=""){this.headers=e,this.payload=t,this.signature=n}static issue(e,t=null,n=Math.floor(Date.now()/1e3)){if(n<0)throw new Error("The timestamp must be non-negative.");if(""===t)throw new Error("The subject must be non-empty.");return new i({typ:"JWT",alg:"none",appId:e},{iss:"croct.io",aud:"croct.io",iat:n,...null!==t?{sub:t}:null})}static parse(t){if(""===t)throw new Error("The token cannot be empty.");const n=t.split(".",3);if(n.length<2)throw new Error("The token is malformed.");let r,o,s;try{r=JSON.parse((0,e.base64UrlDecode)(n[0],!0)),o=JSON.parse((0,e.base64UrlDecode)(n[1],!0)),3===n.length&&(s=(0,e.base64UrlDecode)(n[2],!1))}catch{throw new Error("The token is corrupted.")}return i.of(r,o,s)}static of(e,r,o=""){try{t.tokenSchema.validate({headers:e,payload:r,signature:o})}catch(e){throw new Error(`The token is invalid: ${(0,n.formatCause)(e)}`)}return new i(e,r,o)}getHeaders(){return{...this.headers}}getPayload(){return{...this.payload}}getSignature(){return this.signature}isAnonymous(){return void 0===this.payload.sub}getSubject(){return void 0!==this.payload.sub?this.payload.sub:null}getIssueTime(){return this.payload.iat}toJSON(){return this.toString()}toString(){return`${(0,e.base64UrlEncode)(JSON.stringify(this.headers),!0)}.${(0,e.base64UrlEncode)(JSON.stringify(this.payload),!0)}.${(0,e.base64UrlEncode)(this.signature,!1)}`}}Ve.Token=i;return Ve.FixedTokenProvider=class{constructor(e){this.token=e}getToken(){return this.token}},Ve}var Qe,Je={};var Xe,Ge={};var Ke,We={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.ReplicatedTokenStore=e.InMemoryTokenStore=e.CachedTokenStore=void 0;p.__exportStar(ze(),e);var t=function(){if(Qe)return Je;Qe=1,Object.defineProperty(Je,"__esModule",{value:!0}),Je.CachedTokenStore=void 0;const e=ze();return Je.CachedTokenStore=class{constructor(e){this.cache=e}getToken(){const t=this.cache.get();if(null===t)return null;try{return e.Token.parse(t)}catch(e){return null}}setToken(e){null!==e?this.cache.put(e.toString()):this.cache.clear()}},Je}();Object.defineProperty(e,"CachedTokenStore",{enumerable:!0,get:function(){return t.CachedTokenStore}});var n=(Xe||(Xe=1,Object.defineProperty(Ge,"__esModule",{value:!0}),Ge.InMemoryTokenStore=void 0,Ge.InMemoryTokenStore=class{constructor(){this.token=null}getToken(){return this.token}setToken(e){this.token=e}}),Ge);Object.defineProperty(e,"InMemoryTokenStore",{enumerable:!0,get:function(){return n.InMemoryTokenStore}});var r=(Ke||(Ke=1,Object.defineProperty(We,"__esModule",{value:!0}),We.ReplicatedTokenStore=void 0,We.ReplicatedTokenStore=class{constructor(e,t){this.primary=e,this.secondary=t}getToken(){return this.primary.getToken()}setToken(e){this.primary.setToken(e),this.secondary.setToken(e)}}),We);Object.defineProperty(e,"ReplicatedTokenStore",{enumerable:!0,get:function(){return r.ReplicatedTokenStore}})}(De);var Ye,Ze={},He={},et={},tt={};var nt,rt={};var it,ot={};var st,at={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.NullLogger=e.NamespacedLogger=e.ConsoleLogger=void 0;p.__exportStar((Ye||(Ye=1,Object.defineProperty(tt,"__esModule",{value:!0})),tt),e);var t=(nt||(nt=1,Object.defineProperty(rt,"__esModule",{value:!0}),rt.ConsoleLogger=void 0,rt.ConsoleLogger=class{constructor(e){this.namespace=e}get debug(){return this.bind(window.console.debug)}get info(){return this.bind(window.console.info)}get warn(){return this.bind(window.console.warn)}get error(){return this.bind(window.console.error)}bind(e){return void 0!==this.namespace?e.bind(window.console,`[${this.namespace}]`):e.bind(window.console)}}),rt);Object.defineProperty(e,"ConsoleLogger",{enumerable:!0,get:function(){return t.ConsoleLogger}});var n=(it||(it=1,Object.defineProperty(ot,"__esModule",{value:!0}),ot.NamespacedLogger=void 0,ot.NamespacedLogger=class{constructor(e,t){this.logger=e,this.namespace=t}debug(e){this.logger.debug(this.format(e))}info(e){this.logger.info(this.format(e))}warn(e){this.logger.warn(this.format(e))}error(e){this.logger.error(this.format(e))}format(e){return`[${this.namespace}] ${e}`}}),ot);Object.defineProperty(e,"NamespacedLogger",{enumerable:!0,get:function(){return n.NamespacedLogger}});var r=(st||(st=1,Object.defineProperty(at,"__esModule",{value:!0}),at.NullLogger=void 0,at.NullLogger=class{debug(){}info(){}warn(){}error(){}}),at);Object.defineProperty(e,"NullLogger",{enumerable:!0,get:function(){return r.NullLogger}})}(et);var ct={},ut={},lt={};Object.defineProperty(lt,"__esModule",{value:!0}),lt.SynchronousEventManager=void 0;lt.SynchronousEventManager=class{constructor(){this.listeners={}}addListener(e,t){var n;const r=null!==(n=this.listeners[e])&&void 0!==n?n:[];r.push(t),this.listeners[e]=r}removeListener(e,t){const n=this.listeners[e];if(void 0===n)return;const r=n.indexOf(t);r>=0&&n.splice(r,1)}dispatch(e,t){const n=this.listeners[e];void 0!==n&&n.forEach((e=>e(t)))}},Object.defineProperty(ut,"__esModule",{value:!0}),ut.Tab=void 0;const dt=lt,ht={focus:"focus",blur:"blur",beforeunload:"unload",DOMContentLoaded:"load",visibilitychange:"visibilityChange"};class pt{constructor(e,t,n){this.eventManager=new dt.SynchronousEventManager,this.id=e,this.isNew=t,this.urlSanitizer=n,this.initialize()}initialize(){const e=e=>{this.emit(ht[e.type],new CustomEvent(ht[e.type],{detail:{tab:this}}))};window.addEventListener("focus",e,!0),window.addEventListener("blur",e,!0),window.addEventListener("beforeunload",e,!0),window.addEventListener("DOMContentLoaded",e,!0),document.addEventListener("visibilitychange",(()=>{this.emit("visibilityChange",new CustomEvent("visibilityChange",{detail:{tab:this,visible:this.isVisible}}))}),!0),pt.addUrlChangeListener((e=>{this.emit("urlChange",new CustomEvent("urlChange",{detail:{tab:this,url:this.sanitizeUrl(e)}}))}))}get url(){return this.sanitizeUrl(window.location.href)}get title(){return document.title}get referrer(){return""===document.referrer?"":this.sanitizeUrl(document.referrer)}get isVisible(){return"visible"===document.visibilityState}get document(){return document}addListener(e,t){this.eventManager.addListener(e,t)}removeListener(e,t){this.eventManager.removeListener(e,t)}sanitizeUrl(e){const t=window.encodeURI(window.decodeURI(e));return void 0!==this.urlSanitizer?this.urlSanitizer(t).toString():t}emit(e,t){this.eventManager.dispatch(e,t)}static addUrlChangeListener(e){let t=window.location.href;const n=()=>{const n=window.location.href;t!==n&&(e(n),t=n)},{pushState:r}=window.history;window.history.pushState=function(...e){const t=r.apply(window.history,e);return n(),t};const{replaceState:i}=window.history;window.history.replaceState=function(...e){const t=i.apply(window.history,e);return n(),t},window.addEventListener("popstate",n,!0)}}ut.Tab=pt;var gt={};Object.defineProperty(gt,"__esModule",{value:!0}),gt.uuid4=void 0,gt.uuid4=function(e=!1){let t="";if(e){const e=Date.now().toString(16).padStart(12,"0").substring(0,12);t=`${e.substring(0,8)}-${e.substring(8,12)}`}for(let e=t.length;e<36;e++)switch(e){case 8:case 13:case 18:case 23:t+="-";break;case 14:t+="4";break;default:{let n=16*Math.random()|0;19===e&&(n=3&n|8),t+=n.toString(16)}}return t},Object.defineProperty(ct,"__esModule",{value:!0}),ct.Context=void 0;const yt=De,mt=ut,ft=gt;function vt(e,t){return e===t||null!==e&&null!==t&&e.toString()===t.toString()}class bt{constructor(e,t,n){this.tab=e,this.tokenStore=t,this.eventDispatcher=n,this.lastToken=t.getToken(),this.syncToken=this.syncToken.bind(this)}static load({cache:e,tokenScope:t,eventDispatcher:n,urlSanitizer:r}){let i=e.tabId.get(),o=!1;null===i&&(i=(0,ft.uuid4)(!0),o=!0);const s=new mt.Tab(i,o,r);switch(e.tabId.clear(),s.addListener("unload",(()=>e.tabId.put(s.id))),t){case"isolated":return new bt(s,new yt.InMemoryTokenStore,n);case"global":{const t=new bt(s,new yt.CachedTokenStore(e.browserToken),n);return e.browserToken.addListener(t.syncToken),t}case"contextual":{const t=new yt.CachedTokenStore(e.tabToken),r=new yt.CachedTokenStore(e.browserToken);return s.isNew&&t.setToken(r.getToken()),s.addListener("visibilityChange",(e=>{e.detail.visible&&r.setToken(t.getToken())})),new bt(s,new yt.ReplicatedTokenStore(t,r),n)}}}getTab(){return this.tab}isAnonymous(){const e=this.getToken();return null==e||e.isAnonymous()}getUser(){const e=this.getToken();return null==e?null:e.getSubject()}getToken(){return this.tokenStore.getToken()}setToken(e){const t=this.lastToken;this.lastToken=e,this.tokenStore.setToken(e),vt(t,e)||this.eventDispatcher.dispatch("tokenChanged",{oldToken:t,newToken:e})}syncToken(){const e=this.tokenStore.getToken(),t=this.lastToken;vt(t,e)||(this.lastToken=e,this.eventDispatcher.dispatch("tokenChanged",{oldToken:t,newToken:e}))}}ct.Context=bt;var wt={};Object.defineProperty(wt,"__esModule",{value:!0}),wt.NamespacedStorage=void 0;wt.NamespacedStorage=class{constructor(e,t){if(""===t)throw new Error("The namespace cannot be empty.");this.storage=e,this.namespace=t}get length(){return this.getKeys().length}clear(){for(const e of this.getKeys())this.storage.removeItem(e)}getItem(e){return this.storage.getItem(this.getPrefixedKey(e))}key(e){const t=this.getKeys();return e>=t.length?null:t[e].substring(this.namespace.length+1)}removeItem(e){this.storage.removeItem(this.getPrefixedKey(e))}setItem(e,t){this.storage.setItem(this.getPrefixedKey(e),t)}getKeys(){const e=[],t=this.getPrefix();for(let n=0;n<this.storage.length;n++){const r=this.storage.key(n);null!==r&&0===r.indexOf(t)&&e.push(r)}return e}getPrefixedKey(e){return this.getPrefix()+e}getPrefix(){return`${this.namespace}.`}};var Tt,kt={},St={};var Pt,Ot={};var _t,Et={};var Ct,xt={};var Lt,jt={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.NeverPolicy=e.MaxAttemptsPolicy=e.BackoffPolicy=e.ArbitraryPolicy=void 0;p.__exportStar((Tt||(Tt=1,Object.defineProperty(St,"__esModule",{value:!0})),St),e);var t=(Pt||(Pt=1,Object.defineProperty(Ot,"__esModule",{value:!0}),Ot.ArbitraryPolicy=void 0,Ot.ArbitraryPolicy=class{constructor(e){if(e.length<1)throw new Error("The list of delays cannot be empty.");this.delays=[...e]}getDelay(e){return this.delays[Math.min(e<0?0:e,this.delays.length-1)]}shouldRetry(){return!0}}),Ot);Object.defineProperty(e,"ArbitraryPolicy",{enumerable:!0,get:function(){return t.ArbitraryPolicy}});var n=(_t||(_t=1,Object.defineProperty(Et,"__esModule",{value:!0}),Et.BackoffPolicy=void 0,Et.BackoffPolicy=class{constructor(e={}){this.minRetryDelay=1e3,this.maxRetryDelay=3e4,this.backoffFactor=2,this.backoffJitter=1,this.maxAttempts=1/0;const{minRetryDelay:t=this.minRetryDelay,maxRetryDelay:n=this.maxRetryDelay,backoffFactor:r=this.backoffFactor,backoffJitter:i=this.backoffJitter,maxAttempts:o=this.maxAttempts}=e;if(t<0)throw new Error("The minimum retry delay must be non-negative.");if(n<t)throw new Error("The maximum retry delay must be greater than the minimum.");if(r<1)throw new Error("The backoff factor must be greater than zero.");if(i<0)throw new Error("The backoff jitter must be non-negative.");if(o<0)throw new Error("The maximum attempts must be non-negative.");this.minRetryDelay=t,this.maxRetryDelay=n,this.backoffFactor=r,this.backoffJitter=i,this.maxAttempts=o}getDelay(e){let t=Math.min(Math.max(this.backoffFactor**e,this.minRetryDelay),this.maxRetryDelay);if(this.backoffJitter>0){const e=Math.ceil(this.minRetryDelay),n=Math.floor(t);t=Math.floor(Math.random()*(n-e+1))+e}return t-=t%1,t}shouldRetry(e){return e<this.maxAttempts}}),Et);Object.defineProperty(e,"BackoffPolicy",{enumerable:!0,get:function(){return n.BackoffPolicy}});var r=(Ct||(Ct=1,Object.defineProperty(xt,"__esModule",{value:!0}),xt.MaxAttemptsPolicy=void 0,xt.MaxAttemptsPolicy=class{constructor(e,t){if(e<0)throw new Error("Delay must be non-negative.");if(t<0)throw new Error("Max attempts must be non-negative.");this.maxAttempts=t,this.delay=e}getDelay(){return this.delay}shouldRetry(e){return e<this.maxAttempts}}),xt);Object.defineProperty(e,"MaxAttemptsPolicy",{enumerable:!0,get:function(){return r.MaxAttemptsPolicy}});var i=(Lt||(Lt=1,Object.defineProperty(jt,"__esModule",{value:!0}),jt.NeverPolicy=void 0,jt.NeverPolicy=class{getDelay(){return 1/0}shouldRetry(){return!1}}),jt);Object.defineProperty(e,"NeverPolicy",{enumerable:!0,get:function(){return i.NeverPolicy}})}(kt);var It,Mt={},Nt={};var At,$t={};var Ut,Ft={};var Rt,qt={};var Dt,Vt={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.PersistentQueue=e.MonitoredQueue=e.InMemoryQueue=e.CapacityRestrictedQueue=void 0;p.__exportStar((It||(It=1,Object.defineProperty(Nt,"__esModule",{value:!0})),Nt),e);var t=(At||(At=1,Object.defineProperty($t,"__esModule",{value:!0}),$t.CapacityRestrictedQueue=void 0,$t.CapacityRestrictedQueue=class{constructor(e,t){this.queue=e,this.capacity=t}all(){return this.queue.all()}getCapacity(){return this.capacity}isEmpty(){return this.queue.isEmpty()}length(){return Math.min(this.capacity,this.queue.length())}peek(){return this.queue.peek()}push(e){if(this.queue.length()>=this.capacity)throw new Error("Maximum queue capacity reached.");this.queue.push(e)}shift(){return this.queue.shift()}}),$t);Object.defineProperty(e,"CapacityRestrictedQueue",{enumerable:!0,get:function(){return t.CapacityRestrictedQueue}});var n=(Ut||(Ut=1,Object.defineProperty(Ft,"__esModule",{value:!0}),Ft.InMemoryQueue=void 0,Ft.InMemoryQueue=class{constructor(...e){this.queue=[],this.queue.unshift(...e)}all(){return this.queue.slice()}getCapacity(){return 1/0}isEmpty(){return 0===this.queue.length}push(e){this.queue.push(e)}peek(){var e;return null!==(e=this.queue[0])&&void 0!==e?e:null}shift(){const e=this.queue.shift();if(void 0===e)throw new Error("The queue is empty.");return e}length(){return this.queue.length}}),Ft);Object.defineProperty(e,"InMemoryQueue",{enumerable:!0,get:function(){return n.InMemoryQueue}});var r=function(){if(Rt)return qt;Rt=1,Object.defineProperty(qt,"__esModule",{value:!0}),qt.MonitoredQueue=void 0;const e=et;return qt.MonitoredQueue=class{constructor(t,n){this.callbacks={},this.queue=t,this.logger=null!=n?n:new e.NullLogger,this.updateStatus()}all(){return this.queue.all()}getCapacity(){return this.queue.getCapacity()}addCallback(e,t){var n;const r=null!==(n=this.callbacks[e])&&void 0!==n?n:[];switch(r.includes(t)||r.push(t),this.callbacks[e]=r,this.status){case e:t(this);break;case"empty":case"almostEmpty":"halfEmpty"===e&&t(this);break;case"full":case"almostFull":"halfFull"===e&&t(this)}}removeCallback(e,t){const n=this.callbacks[e];if(null==n)return;const r=n.indexOf(t);r>=0&&n.splice(r,1)}setStatus(e){this.status!==e&&(this.logger.debug(`Queue status changed to "${e}"`),this.report(e),this.status=e)}report(e){const t=this.callbacks[e];switch(void 0!==t&&t.forEach((e=>e(this))),e){case"empty":case"almostEmpty":this.report("halfEmpty");break;case"full":case"almostFull":this.report("halfFull")}}isEmpty(){return this.queue.isEmpty()}length(){return this.queue.length()}peek(){return this.queue.peek()}push(e){this.queue.push(e),this.updateStatus()}shift(){const e=this.queue.shift();return this.updateStatus(),e}updateStatus(){const e=this.queue.length(),t=this.getCapacity();e<=.5*t?0===e?this.setStatus("empty"):e<=.25*t?this.setStatus("almostEmpty"):this.setStatus("halfEmpty"):e>=t?this.setStatus("full"):e>=.75*t?this.setStatus("almostFull"):this.setStatus("halfFull")}},qt}();Object.defineProperty(e,"MonitoredQueue",{enumerable:!0,get:function(){return r.MonitoredQueue}});var i=(Dt||(Dt=1,Object.defineProperty(Vt,"__esModule",{value:!0}),Vt.PersistentQueue=void 0,Vt.PersistentQueue=class{constructor(e,t="queue"){this.storage=e,this.key=t}all(){return this.queue.slice()}getCapacity(){return 1/0}isEmpty(){return 0===this.length()}length(){return this.queue.length}push(e){this.queue.push(e),this.flush()}peek(){const e=this.queue[0];return void 0===e?null:e}shift(){const e=this.queue.shift();if(void 0===e)throw new Error("The queue is empty.");return this.flush(),e}get queue(){return void 0===this.cache&&(this.cache=this.load()),this.cache}flush(){var e;this.storage.setItem(this.key,JSON.stringify(null!==(e=this.cache)&&void 0!==e?e:[]))}load(){const e=this.storage.getItem(this.key);if(null===e)return[];try{return JSON.parse(e)}catch(e){return[]}}}),Vt);Object.defineProperty(e,"PersistentQueue",{enumerable:!0,get:function(){return i.PersistentQueue}})}(Mt);var Bt,zt={},Qt={};Bt=Qt,Object.defineProperty(Bt,"__esModule",{value:!0}),Bt.isCartPartialEvent=Bt.isIdentifiedUserEvent=Bt.eventTypes=Bt.miscEventTypes=Bt.userEventTypes=Bt.identifiedUserEventTypes=Bt.ecommerceEventTypes=Bt.cartEventTypes=Bt.tabEventTypes=Bt.pageEventTypes=void 0,Bt.pageEventTypes=["pageLoaded","pageOpened"],Bt.tabEventTypes=["tabOpened","tabUrlChanged","tabVisibilityChanged"],Bt.cartEventTypes=["cartModified","cartViewed","checkoutStarted"],Bt.ecommerceEventTypes=[...Bt.cartEventTypes,"orderPlaced","productViewed"],Bt.identifiedUserEventTypes=["userSignedIn","userSignedOut","userSignedUp"],Bt.userEventTypes=[...Bt.identifiedUserEventTypes,"userProfileChanged"],Bt.miscEventTypes=["nothingChanged","sessionAttributesChanged","goalCompleted","interestShown","postViewed","eventOccurred","linkOpened"],Bt.eventTypes=[...Bt.pageEventTypes,...Bt.ecommerceEventTypes,...Bt.userEventTypes,...Bt.miscEventTypes],Bt.isIdentifiedUserEvent=function(e){return Bt.identifiedUserEventTypes.includes(e.type)},Bt.isCartPartialEvent=function(e){return Bt.cartEventTypes.includes(e.type)},Object.defineProperty(zt,"__esModule",{value:!0}),zt.Tracker=void 0;const Jt=et,Xt=we,Gt=Qt,Kt={};zt.Tracker=class{constructor(e){var t;this.listeners=[],this.pending=[],this.state={enabled:!1,initialized:!1,suspended:!1},this.inactivityTimer={since:0};const{tab:n,tokenProvider:r,channel:i,logger:o,inactivityRetryPolicy:s,...a}=e;this.tab=n,this.tokenProvider=r,this.inactivityRetryPolicy=s,this.channel=i,this.logger=null!=o?o:new Jt.NullLogger,this.options={...a,eventMetadata:null!==(t=a.eventMetadata)&&void 0!==t?t:{}},this.enable=this.enable.bind(this),this.disable=this.disable.bind(this),this.suspend=this.suspend.bind(this),this.unsuspend=this.unsuspend.bind(this),this.trackPageLoad=this.trackPageLoad.bind(this),this.trackTabVisibilityChange=this.trackTabVisibilityChange.bind(this),this.trackTabUrlChange=this.trackTabUrlChange.bind(this),this.trackInactivity=this.trackInactivity.bind(this)}addListener(e){this.listeners.push(e)}removeListener(e){let t=this.listeners.indexOf(e);for(;t>=0;)this.listeners.splice(t,1),t=this.listeners.indexOf(e)}get flushed(){const e=()=>{};return Promise.all(this.pending).then(e,e)}isEnabled(){return this.state.enabled}isSuspended(){return this.state.suspended}enable(){this.state.enabled||(this.logger.info("Tracker enabled"),this.state.enabled=!0,this.state.suspended||(this.startInactivityTimer(),this.state.initialized||(this.state.initialized=!0,this.initialize()),this.tab.addListener("load",this.trackPageLoad),this.tab.addListener("urlChange",this.trackTabUrlChange),this.tab.addListener("visibilityChange",this.trackTabVisibilityChange)))}disable(){this.state.enabled&&(this.logger.info("Tracker disabled"),this.state.enabled=!1,this.state.suspended||(this.tab.removeListener("load",this.trackPageLoad),this.tab.removeListener("urlChange",this.trackTabUrlChange),this.tab.removeListener("visibilityChange",this.trackTabVisibilityChange),this.stopInactivityTimer()))}suspend(){this.state.suspended||(this.logger.info("Tracker suspended"),this.state.enabled&&(this.disable(),this.state.enabled=!0),this.state.suspended=!0)}unsuspend(){this.state.suspended&&(this.logger.info("Tracker unsuspended"),this.state.suspended=!1,this.state.enabled&&(this.state.enabled=!1,this.enable()))}initialize(){void 0===Kt[this.tab.id]&&(Kt[this.tab.id]={});const e=Kt[this.tab.id];this.tab.isNew&&!e.tabOpened&&(e.tabOpened=!0,this.trackTabOpen({tabId:this.tab.id})),e.pageOpened||(e.pageOpened=!0,this.trackPageOpen({url:this.tab.url,referrer:this.tab.referrer}))}stopInactivityTimer(){void 0!==this.inactivityTimer.id&&(window.clearTimeout(this.inactivityTimer.id),delete this.inactivityTimer.id)}startInactivityTimer(){this.stopInactivityTimer(),this.inactivityTimer.since=Date.now();let e=-1;const t=()=>{this.inactivityRetryPolicy.shouldRetry(e+1,this.inactivityTimer.since)?(e+=1,this.inactivityTimer.id=window.setTimeout((()=>{this.trackInactivity(),t()}),this.inactivityRetryPolicy.getDelay(e))):window.clearTimeout(this.inactivityTimer.id)};t()}track(e,t=Date.now()){return this.publish(this.enrichEvent(e,t),t).then((()=>e))}trackPageOpen({referrer:e,...t}){this.enqueue({type:"pageOpened",...t,...e.length>0?{referrer:e}:{}})}trackPageLoad({detail:{tab:e}}){this.enqueue({type:"pageLoaded",url:e.url,title:e.title,lastModifiedTime:Date.parse(e.document.lastModified)})}trackTabOpen(e){this.enqueue({type:"tabOpened",...e})}trackTabUrlChange({detail:e}){this.enqueue({type:"tabUrlChanged",tabId:e.tab.id,url:e.url})}trackTabVisibilityChange({detail:e}){this.enqueue({type:"tabVisibilityChanged",tabId:e.tab.id,visibility:e.visible?"visible":"hidden"})}trackInactivity(){this.enqueue({type:"nothingChanged",sinceTime:this.inactivityTimer.since})}enqueue(e,t=Date.now()){this.publish(e,t).catch((()=>{}))}notifyEvent(e){this.listeners.map((t=>t(e)))}publish(e,t){"nothingChanged"!==e.type&&this.stopInactivityTimer();const n=this.options.eventMetadata,r={tabId:this.tab.id,url:this.tab.url,...Object.keys(n).length>0?{metadata:n}:{}},i={event:e,context:r,timestamp:t,status:"pending"};return this.state.suspended?(this.logger.warn(`Tracker is suspended, ignoring event "${e.type}"`),this.notifyEvent({...i,status:"ignored"}),Promise.reject(new Error("The tracker is suspended."))):(this.logger.info(`Tracked event "${e.type}"`),this.notifyEvent(i),new Promise(((n,o)=>{const s=this.channel.publish(this.createBeacon(e,t,r)).then((()=>{this.logger.debug(`Successfully published event "${e.type}"`),this.notifyEvent({...i,status:"confirmed"}),n(e)}),(t=>{this.logger.error(`Failed to publish event "${e.type}", reason: ${(0,Xt.formatCause)(t)}`),this.notifyEvent({...i,status:"failed"}),o(t)}));this.pending.push(s),s.finally((()=>{this.pending.splice(this.pending.indexOf(s),1)})),this.state.enabled&&"nothingChanged"!==e.type&&this.startInactivityTimer()})))}enrichEvent(e,t){if((0,Gt.isCartPartialEvent)(e)){const{cart:{lastUpdateTime:n=t,...r},...i}=e;return{...i,cart:{...r,lastUpdateTime:n}}}return e}createBeacon(e,t,n){const r=this.tokenProvider.getToken();return{timestamp:t,...null!==r?{token:r.toString()}:{},context:n,payload:this.enrichBeaconPayload(this.createBeaconPayload(e))}}createBeaconPayload(e){if(!(0,Gt.isIdentifiedUserEvent)(e))return e;if("userSignedUp"===e.type&&void 0!==e.profile){const{userId:t,profile:n,...r}=e;return{...r,externalUserId:t,patch:{operations:[{type:"merge",path:".",value:n}]}}}const{userId:t,...n}=e;return{...n,externalUserId:t}}enrichBeaconPayload(e){return"linkOpened"===e.type?{...e,link:new URL(e.link,this.tab.url).toString()}:e}};var Wt={},Yt={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.CLIENT_LIBRARY=e.VERSION=e.MAX_QUERY_LENGTH=e.BASE_ENDPOINT_URL=void 0,e.BASE_ENDPOINT_URL="https://api.croct.io",e.MAX_QUERY_LENGTH=500,e.VERSION="0.14.0",e.CLIENT_LIBRARY=`Croct SDK JS v${e.VERSION}`}(Yt);var Zt={};function Ht(e,t,n){if(t<0)throw Error("The start index cannot be negative.");if(n<t)throw new Error("The end index must greater than or equal to the start index.");let r,i;const o=[...e];let s=1,a=0;for(let e=0;e<o.length;e++){const c=o[e];if(e===t&&(r={index:e,line:s,column:a}),e===n){i={index:e,line:s,column:a};break}"\n"===c?(s+=1,a=0):a+=1}return void 0===r&&(r={index:o.length,line:s,column:a}),void 0===i&&(i={index:o.length,line:s,column:a}),{start:r,end:i}}Object.defineProperty(Zt,"__esModule",{value:!0}),Zt.getPosition=Zt.getLocation=Zt.getLength=void 0,Zt.getLength=function(e){return[...e].length},Zt.getLocation=Ht,Zt.getPosition=function(e,t){return Ht(e,t,t).start},Object.defineProperty(Wt,"__esModule",{value:!0}),Wt.Evaluator=Wt.QueryError=Wt.EvaluationError=Wt.EvaluationErrorType=void 0;const en=Yt,tn=we,nn=Zt,rn=et;var on;!function(e){e.TIMEOUT="https://croct.help/api/evaluation#timeout",e.UNEXPECTED_ERROR="https://croct.help/api/evaluation#unexpected-error",e.INVALID_QUERY="https://croct.help/api/evaluation#invalid-query",e.TOO_COMPLEX_QUERY="https://croct.help/api/evaluation#too-complex-query",e.EVALUATION_FAILED="https://croct.help/api/evaluation#evaluation-failed",e.UNALLOWED_RESULT="https://croct.help/api/evaluation#unallowed-result",e.UNSERIALIZABLE_RESULT="https://croct.help/api/evaluation#unserializable-result"}(on||(Wt.EvaluationErrorType=on={}));class sn extends Error{constructor(e){super(e.title),this.response=e,Object.setPrototypeOf(this,sn.prototype)}}Wt.EvaluationError=sn;class an extends sn{constructor(e){super(e),Object.setPrototypeOf(this,an.prototype)}}Wt.QueryError=an;class cn{constructor(e){var t;if(void 0===e.appId==(void 0===e.apiKey))throw new Error("Either the application ID or the API key must be provided.");const{baseEndpointUrl:n,apiKey:r}=e;this.endpoint=(null!=n?n:en.BASE_ENDPOINT_URL).replace(/\/+$/,"")+(void 0===r?"/client":"/external")+"/web/evaluate",this.configuration=e,this.logger=null!==(t=e.logger)&&void 0!==t?t:new rn.NullLogger}evaluate(e,t={}){const n=(0,nn.getLength)(e);if(n>cn.MAX_QUERY_LENGTH){const t={title:"The query is too complex.",status:422,type:on.TOO_COMPLEX_QUERY,detail:`The query must be at most ${cn.MAX_QUERY_LENGTH} characters long, but it is ${n} characters long.`,errors:[{cause:"The query is longer than expected.",location:(0,nn.getLocation)(e,0,Math.max(n-1,0))}]};return Promise.reject(new an(t))}const r={query:e};return void 0!==t.context&&(r.context=t.context),new Promise(((e,n)=>{const i=new AbortController;void 0!==t.timeout&&setTimeout((()=>{const e={title:"Maximum evaluation timeout reached before evaluation could complete.",type:on.TIMEOUT,detail:`The evaluation took more than ${t.timeout}ms to complete.`,status:408};i.abort(),n(new sn(e))}),t.timeout);this.fetch(r,i.signal,t).then((t=>t.json().then((r=>{if(t.ok)return e(r);const i=r;switch(i.type){case on.INVALID_QUERY:case on.EVALUATION_FAILED:case on.TOO_COMPLEX_QUERY:n(new an(i));break;default:n(new sn(i))}})).catch((e=>{if(!t.ok)throw new Error(`Error ${t.status} - ${t.statusText}`);throw e})))).catch((e=>{i.signal.aborted||n(new sn({title:(0,tn.formatMessage)(e),type:on.UNEXPECTED_ERROR,detail:"Please try again or contact Croct support if the error persists.",status:500}))}))}))}fetch(e,t,n){var r;const{appId:i,apiKey:o}=this.configuration,{clientId:s,clientIp:a,userToken:c}=n,u=null!==(r=n.clientAgent)&&void 0!==r?r:n.userAgent;void 0!==n.userAgent&&this.logger.warn("The `userAgent` option is deprecated and will be removed in future releases. Please update the part of your code calling the `evaluate` method to use the `clientAgent` option instead.");const l={"Content-Type":"application/json"};return l["X-Client-Library"]=en.CLIENT_LIBRARY,void 0!==o?l["X-Api-Key"]=o:void 0!==i&&(l["X-App-Id"]=i),void 0!==s&&(l["X-Client-Id"]=s),void 0!==a&&(l["X-Client-Ip"]=a),void 0!==c&&(l["X-Token"]=c.toString()),void 0!==u&&(l["X-Client-Agent"]=u),fetch(this.endpoint,{credentials:"omit",...n.extra,method:"POST",headers:l,signal:t,body:JSON.stringify(e)})}toJSON(){throw new Error("Unserializable value.")}}Wt.Evaluator=cn,cn.MAX_QUERY_LENGTH=en.MAX_QUERY_LENGTH;var un={};Object.defineProperty(un,"__esModule",{value:!0}),un.encodeJson=void 0;un.encodeJson=function(e){return Promise.resolve(JSON.stringify(e))};var ln,dn={},hn={};var pn,gn={};var yn,mn={};var fn,vn={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.RemoteAssigner=e.FixedAssigner=e.CachedAssigner=void 0;p.__exportStar((ln||(ln=1,Object.defineProperty(hn,"__esModule",{value:!0})),hn),e);var t=function(){if(pn)return gn;pn=1,Object.defineProperty(gn,"__esModule",{value:!0}),gn.CachedAssigner=void 0;const e=et;return gn.CachedAssigner=class{constructor(t,n,r={}){var i,o;this.assigner=t,this.cache=n,this.options={logger:null!==(i=r.logger)&&void 0!==i?i:new e.NullLogger,mirror:null!==(o=r.mirror)&&void 0!==o&&o}}async assignCid(e){var t;const n=this.cache.get(),r=null!==(t=null!=e?e:n)&&void 0!==t?t:null,{logger:i,mirror:o}=this.options;if(null===r){const e=await this.assigner.assignCid();return this.cache.put(e),i.debug("New CID stored into cache"),e}return i.debug("Using existing CID"),n!==r&&(i.debug("The cached CID is stale, updating cache..."),this.cache.put(r)),o&&(i.debug("Mirroring CID"),this.assigner.assignCid(r).then((e=>{e!==r&&(i.warn("The CID has changed, updating cache..."),this.cache.put(e))})).catch((()=>{i.error("Failed to mirror CID")}))),r}},gn}();Object.defineProperty(e,"CachedAssigner",{enumerable:!0,get:function(){return t.CachedAssigner}});var n=(yn||(yn=1,Object.defineProperty(mn,"__esModule",{value:!0}),mn.FixedAssigner=void 0,mn.FixedAssigner=class{constructor(e){this.cid=e}assignCid(){return Promise.resolve(this.cid)}}),mn);Object.defineProperty(e,"FixedAssigner",{enumerable:!0,get:function(){return n.FixedAssigner}});var r=function(){if(fn)return vn;fn=1,Object.defineProperty(vn,"__esModule",{value:!0}),vn.RemoteAssigner=void 0;const e=et,t=we,n=Yt;return vn.RemoteAssigner=class{constructor(t,n){this.endpoint=t,this.logger=null!=n?n:new e.NullLogger}assignCid(e){return void 0===this.pending&&(this.pending=this.fetchCid(e).finally((()=>{this.pending=void 0}))),this.pending}async fetchCid(e){const r={method:"GET",credentials:"include",headers:{"X-Client-Library":n.CLIENT_LIBRARY}},i=new URL(this.endpoint);void 0!==e&&i.searchParams.set("cid",e);const o=await fetch(i,r);if(!o.ok){const e=new Error(`Failed to assign CID: ${(0,t.formatCause)(o.statusText)}`);throw this.logger.error(e.message),e}return this.logger.debug("New CID successfully assigned"),o.text()}},vn}();Object.defineProperty(e,"RemoteAssigner",{enumerable:!0,get:function(){return r.RemoteAssigner}})}(dn);var bn,wn={},Tn={};var kn,Sn={};var Pn,On={};var _n,En={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.LocalStorageCache=e.InMemoryCache=e.FallbackCache=void 0;p.__exportStar((bn||(bn=1,Object.defineProperty(Tn,"__esModule",{value:!0})),Tn),e);var t=(kn||(kn=1,Object.defineProperty(Sn,"__esModule",{value:!0}),Sn.FallbackCache=void 0,Sn.FallbackCache=class{constructor(...e){this.caches=e}get(){for(const e of this.caches){const t=e.get();if(null!==t)return t}return null}put(e){this.caches.forEach((t=>t.put(e)))}clear(){this.caches.forEach((e=>e.clear()))}}),Sn);Object.defineProperty(e,"FallbackCache",{enumerable:!0,get:function(){return t.FallbackCache}});var n=(Pn||(Pn=1,Object.defineProperty(On,"__esModule",{value:!0}),On.InMemoryCache=void 0,On.InMemoryCache=class{constructor(e){this.cache=e}get(){var e;return null!==(e=this.cache)&&void 0!==e?e:null}put(e){this.cache=e}clear(){delete this.cache}}),On);Object.defineProperty(e,"InMemoryCache",{enumerable:!0,get:function(){return n.InMemoryCache}});var r=(_n||(_n=1,Object.defineProperty(En,"__esModule",{value:!0}),En.LocalStorageCache=void 0,En.LocalStorageCache=class{constructor(e,t){this.listeners=[],this.storage=e,this.key=t,this.value=e.getItem(t)}static autoSync(e){const t=e.sync.bind(e);return window.addEventListener("storage",t),()=>window.removeEventListener("storage",t)}get(){return this.value}put(e){this.storage.setItem(this.key,e),this.value!==e&&(this.value=e,this.notifyChange(e))}clear(){this.storage.removeItem(this.key),null!==this.value&&(this.value=null,this.notifyChange(null))}addListener(e){this.listeners.includes(e)||this.listeners.push(e)}removeListener(e){const t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}notifyChange(e){this.listeners.forEach((t=>t(e)))}sync(e){if(e.storageArea!==this.storage||null!==e.key&&e.key!==this.key)return;const t=this.storage.getItem(this.key);this.value!==t&&(this.value=t,this.notifyChange(t))}}),En);Object.defineProperty(e,"LocalStorageCache",{enumerable:!0,get:function(){return r.LocalStorageCache}})}(wn);var Cn={};Object.defineProperty(Cn,"__esModule",{value:!0}),Cn.GuaranteedChannel=Cn.TimeStamper=void 0;const xn=et;Cn.TimeStamper=class{generate(){return String(Date.now())}};Cn.GuaranteedChannel=class{constructor({channel:e,logger:t,stamper:n,...r}){var i;this.closed=!1,this.channel=e,this.logger=null!=t?t:new xn.NullLogger,this.stamper=n,this.options={...r,ackTimeout:null!==(i=r.ackTimeout)&&void 0!==i?i:5e3}}publish(e){return this.closed?Promise.reject(new Error("Channel is closed.")):new Promise(((t,n)=>{const r=this.stamper.generate(e);let i,o,s=!1;const a=Date.now(),c=e=>{if(e===r){s=!0;const e=Date.now()-a;window.clearTimeout(i),window.clearInterval(o),this.logger.debug(`Delivery confirmed #${r}, elapsed ${e}ms.`),this.channel.unsubscribe(c),t()}};this.channel.subscribe(c);const u=e=>{window.clearTimeout(i),window.clearInterval(o),this.logger.error(`Failed to send message #${r}`),this.channel.unsubscribe(c),n(e)};this.logger.debug(`Sending message #${r}...`),this.channel.publish({id:r,message:e}).then((()=>{s||(o=window.setInterval((()=>{this.closed&&u(new Error("Connection deliberately closed."))}),0),this.logger.debug(`Waiting confirmation #${r}...`),i=window.setTimeout((()=>{u(new Error("Maximum confirmation time reached."))}),this.options.ackTimeout))}),u)}))}close(){return this.closed=!0,this.channel.close()}};var Ln,jn={},In={};var Mn,Nn={};var An,$n={};var Un,Fn={};var Rn,qn={};var Dn,Vn={};var Bn,zn={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.SocketChannel=e.SandboxChannel=e.RetryChannel=e.QueuedChannel=e.GuaranteedChannel=e.EncodedChannel=e.BeaconSocketChannel=void 0;p.__exportStar((Ln||(Ln=1,Object.defineProperty(In,"__esModule",{value:!0})),In),e);var t=function(){if(Mn)return Nn;Mn=1,Object.defineProperty(Nn,"__esModule",{value:!0}),Nn.BeaconSocketChannel=void 0;const e=et;return Nn.BeaconSocketChannel=class{constructor(t){var n,r;this.listeners=[],this.connectionIndex=0,this.socketFactory=t.channelFactory,this.logger=null!==(n=t.logger)&&void 0!==n?n:new e.NullLogger,this.loggerFactory=null!==(r=t.loggerFactory)&&void 0!==r?r:()=>new e.NullLogger,this.cidAssigner=t.cidAssigner,this.cidParameter=t.cidParameter,this.trackerEndpointUrl=t.trackerEndpointUrl,this.tokenParameter=t.tokenParameter,this.notify=this.notify.bind(this)}async publish({id:e,message:t}){const{token:n,timestamp:r,context:i,payload:o}=JSON.parse(t);return this.token===n&&void 0!==this.socketChannel||(void 0!==this.socketChannel&&(this.logger.info("Connection no longer valid for current message."),this.socketChannel.unsubscribe(this.notify),await this.socketChannel.close()),this.token=n,this.socketChannel=await this.createSocketChannel(n)),this.socketChannel.publish(JSON.stringify({receiptId:e,originalTime:r,departureTime:Date.now(),context:i,payload:o}))}async createSocketChannel(e){const t=new URL(this.trackerEndpointUrl);t.searchParams.append(this.cidParameter,await this.cidAssigner.assignCid()),void 0!==e&&t.searchParams.append(this.tokenParameter,e);const n=this.socketFactory(t.toString(),this.loggerFactory(`WebSocket#${this.connectionIndex}`));return this.connectionIndex+=1,n.subscribe(this.notify),n}subscribe(e){this.listeners.includes(e)||this.listeners.push(e)}unsubscribe(e){const t=this.listeners.indexOf(e);t>=0&&this.listeners.splice(t,1)}notify(e){let t;try{t=JSON.parse(e)}catch{return void this.logger.error("Invalid JSON message received.")}const{violations:n=[],receiptId:r}=t;n.forEach((e=>this.logger.error(e.message))),null!==r&&this.listeners.forEach((e=>e(r)))}close(){return void 0===this.socketChannel?Promise.resolve():this.socketChannel.close()}},Nn}();Object.defineProperty(e,"BeaconSocketChannel",{enumerable:!0,get:function(){return t.BeaconSocketChannel}});var n=(An||(An=1,Object.defineProperty($n,"__esModule",{value:!0}),$n.EncodedChannel=void 0,$n.EncodedChannel=class{constructor(e,t){this.channel=e,this.encode=t}publish(e){return this.encode(e).then((e=>this.channel.publish(e)))}close(){return this.channel.close()}}),$n);Object.defineProperty(e,"EncodedChannel",{enumerable:!0,get:function(){return n.EncodedChannel}});var r=Cn;Object.defineProperty(e,"GuaranteedChannel",{enumerable:!0,get:function(){return r.GuaranteedChannel}});var i=function(){if(Un)return Fn;Un=1,Object.defineProperty(Fn,"__esModule",{value:!0}),Fn.QueuedChannel=void 0;const e=et;return Fn.QueuedChannel=class{constructor(t,n,r){this.closed=!1,this.channel=t,this.queue=n,this.logger=null!=r?r:new e.NullLogger}flush(){return void 0===this.pending?this.requeue():this.pending.catch(this.requeue.bind(this))}publish(e){return this.closed?Promise.reject(new Error("Channel is closed.")):this.queue.length()>=this.queue.getCapacity()?(this.logger.warn("The queue is full, message rejected."),Promise.reject(new Error("The queue is full."))):(void 0===this.pending&&(this.pending=this.queue.isEmpty()?Promise.resolve():Promise.reject(new Error("The queue must be flushed."))),this.enqueue(e),this.pending=this.pending.then((()=>this.channel.publish(e).then(this.dequeue.bind(this)))),this.pending)}enqueue(e){this.logger.debug("Enqueueing message..."),this.logger.debug(`Queue length: ${this.queue.length()+1}`),this.queue.push(e)}dequeue(){this.logger.debug("Dequeuing message..."),this.logger.debug(`Queue length: ${Math.max(0,this.queue.length()-1)}`),this.queue.shift()}requeue(){if(this.closed)return Promise.reject(new Error("Channel is closed."));if(this.pending=Promise.resolve(),this.queue.isEmpty())return this.pending;const e=this.queue.length();this.logger.debug("Requeuing messages..."),this.logger.debug(`Queue length: ${e}`);for(const e of this.queue.all())this.pending=this.pending.then((()=>this.channel.publish(e).then(this.dequeue.bind(this))));return this.pending}async close(){if(this.closed=!0,await this.channel.close(),void 0!==this.pending)try{await this.pending}catch{}}},Fn}();Object.defineProperty(e,"QueuedChannel",{enumerable:!0,get:function(){return i.QueuedChannel}});var o=function(){if(Rn)return qn;Rn=1,Object.defineProperty(qn,"__esModule",{value:!0}),qn.RetryChannel=void 0;const e=et;return qn.RetryChannel=class{constructor({channel:t,retryPolicy:n,logger:r}){this.closed=!1,this.channel=t,this.retryPolicy=n,this.logger=null!=r?r:new e.NullLogger}publish(e){return this.closed?Promise.reject(new Error("The channel is closed.")):this.channel.publish(e).catch((t=>this.retry(e,t)))}async retry(e,t){let n=0;for(;this.retryPolicy.shouldRetry(n,e,t);){if(this.closed)throw new Error("Connection deliberately closed.");const t=this.retryPolicy.getDelay(n);this.logger.debug(`Retry attempt ${n+1}`),t>0&&(this.logger.debug(`Retry attempt delayed in ${t}ms`),await new Promise(((e,n)=>{const r=window.setInterval((()=>{this.closed&&(window.clearInterval(r),n(new Error("Connection deliberately closed.")))}),0);window.setTimeout((()=>{window.clearInterval(r),e()}),t)})));try{return await this.channel.publish(e)}catch{n+=1}}throw new Error("Maximum retry attempts reached.")}close(){return this.closed=!0,this.channel.close()}},qn}();Object.defineProperty(e,"RetryChannel",{enumerable:!0,get:function(){return o.RetryChannel}});var s=(Dn||(Dn=1,Object.defineProperty(Vn,"__esModule",{value:!0}),Vn.SandboxChannel=void 0,Vn.SandboxChannel=class{constructor(){this.listeners=[],this.messages=[],this.closed=!1}publish(e){return this.messages.push(e),Promise.resolve()}notify(e){this.listeners.forEach((t=>t(e)))}subscribe(e){this.listeners.includes(e)||this.listeners.push(e)}unsubscribe(e){const t=this.listeners.indexOf(e);t>=0&&this.listeners.splice(t,1)}close(){return this.closed=!0,Promise.resolve()}isClosed(){return this.closed}}),Vn);Object.defineProperty(e,"SandboxChannel",{enumerable:!0,get:function(){return s.SandboxChannel}});var a=function(){if(Bn)return zn;Bn=1,Object.defineProperty(zn,"__esModule",{value:!0}),zn.SocketChannel=void 0;const e=et,t=we;return zn.SocketChannel=class{constructor({url:t,logger:n,...r}){var i,o,s;this.listeners=[],this.closed=!1,this.url=t,this.logger=null!=n?n:new e.NullLogger,this.options={...r,closeTimeout:null!==(i=r.closeTimeout)&&void 0!==i?i:5e3,connectionTimeout:null!==(o=r.connectionTimeout)&&void 0!==o?o:1e4,protocols:null!==(s=r.protocols)&&void 0!==s?s:[]}}get connected(){return void 0===this.connection?Promise.resolve(!1):this.connection.then((()=>!0),(()=>!1))}publish(e){return this.connect().then((t=>{t.send(e),this.logger.debug("Message sent.")}))}subscribe(e){this.listeners.includes(e)||this.listeners.push(e)}unsubscribe(e){const t=this.listeners.indexOf(e);t>=0&&this.listeners.splice(t,1)}notify(e){this.listeners.forEach((t=>t(e)))}connect(){return this.closed?Promise.reject(new Error("Channel has been closed.")):void 0!==this.connection?this.connection.then((e=>{if(e.readyState===WebSocket.OPEN)return e;throw new Error("Connection lost.")})).catch((()=>(delete this.connection,this.connect()))):(this.connection=new Promise(((e,n)=>{this.logger.debug("Connecting...");const r=new window.WebSocket(this.url,this.options.protocols);void 0!==this.options.binaryType&&(r.binaryType=this.options.binaryType);const i=window.setTimeout((()=>{const e="Maximum connection timeout reached.";this.logger.error(e),n(new Error(e)),r.close(1e3,e)}),this.options.connectionTimeout),o=()=>{window.clearTimeout(i),this.logger.info("Connection established."),r.removeEventListener("open",o),e(r)},s=()=>{this.closed||this.logger.error("Connection error.")},a=e=>{this.logger.debug("Message received."),this.notify(e.data)},c=e=>{var u;window.clearTimeout(i);const l=`Connection has been closed, reason: ${(0,t.formatCause)(null!==(u=e.reason)&&void 0!==u?u:"unknown")} (code ${e.code})`;this.closed||this.logger.info(l),r.removeEventListener("open",o),r.removeEventListener("error",s),r.removeEventListener("close",c),r.removeEventListener("message",a),n(new Error(l))};r.addEventListener("open",o,{once:!0}),r.addEventListener("close",c,{once:!0}),r.addEventListener("error",s),r.addEventListener("message",a)})),this.connection)}close(){return this.logger.debug("Closing connection..."),new Promise(((e,t)=>{if(this.closed=!0,void 0===this.connection)return this.logger.debug("Connection is not open."),void e();this.connection.then((n=>{let r;n.addEventListener("close",(()=>{window.clearTimeout(r),this.logger.info("Connection gracefully closed."),e()}),{once:!0}),n.close(1e3,"Deliberate disconnection."),r=window.setTimeout((()=>{this.logger.warn("Connection could not be closed within the timeout period."),t(new Error("Maximum close timeout reached."))}),this.options.closeTimeout)}),(()=>{this.logger.info("Connection closed."),e()}))}))}},zn}();Object.defineProperty(e,"SocketChannel",{enumerable:!0,get:function(){return a.SocketChannel}})}(jn);var Qn={};Object.defineProperty(Qn,"__esModule",{value:!0}),Qn.ContentFetcher=Qn.ContentError=Qn.ContentErrorType=void 0;const Jn=Yt,Xn=we,Gn=et;var Kn;!function(e){e.TIMEOUT="https://croct.help/api/content#timeout",e.UNEXPECTED_ERROR="https://croct.help/api/content#unexpected-error"}(Kn||(Qn.ContentErrorType=Kn={}));class Wn extends Error{constructor(e){super(e.title),this.response=e,Object.setPrototypeOf(this,Wn.prototype)}}Qn.ContentError=Wn;class Yn{constructor(e){var t;if(void 0===e.appId==(void 0===e.apiKey))throw new Error("Either the application ID or the API key must be provided.");this.configuration=e;const{apiKey:n,baseEndpointUrl:r}=e,i=(null!=r?r:Jn.BASE_ENDPOINT_URL).replace(/\/+$/,"")+(void 0===n?"/client":"/external")+"/web";this.dynamicEndpoint=`${i}/content`,this.staticEndpoint=`${i}/static-content`,this.logger=null!==(t=e.logger)&&void 0!==t?t:new Gn.NullLogger}fetch(e,t={}){if(!0===t.static&&void 0===this.configuration.apiKey)throw new Error("The API key must be provided to fetch static content.");return new Promise(((n,r)=>{const i=new AbortController;void 0!==t.timeout&&setTimeout((()=>{const e={title:"Maximum timeout reached before content could be loaded.",type:Kn.TIMEOUT,detail:`The content took more than ${t.timeout}ms to load.`,status:408};i.abort(),r(new Wn(e))}),t.timeout),this.load(e,i.signal,t).then((e=>e.json().then((t=>{e.ok?n(t):r(new Wn(t))})).catch((t=>{if(!e.ok)throw new Error(`Error ${e.status} - ${e.statusText}`);throw t})))).catch((e=>{i.signal.aborted||r(new Wn({title:(0,Xn.formatMessage)(e),type:Kn.UNEXPECTED_ERROR,detail:"Please try again or contact Croct support if the error persists.",status:500}))}))}))}load(e,t,n){var r;const{apiKey:i,appId:o}=this.configuration,s={"Content-Type":"application/json"};s["X-Client-Library"]=Jn.CLIENT_LIBRARY,void 0!==o&&(s["X-App-Id"]=o),void 0!==i&&(s["X-Api-Key"]=i);const a={slotId:e};void 0!==n.version&&(a.version=`${n.version}`),void 0!==n.preferredLocale&&(a.preferredLocale=n.preferredLocale);const c=Yn.isDynamicContent(n);if(c){void 0!==n.userAgent&&this.logger.warn("The `userAgent` option is deprecated and will be removed in future releases. Please update the part of your code calling the `fetch` method to use the `clientAgent` option instead."),void 0!==n.clientId&&(s["X-Client-Id"]=n.clientId),void 0!==n.clientIp&&(s["X-Client-Ip"]=n.clientIp),void 0!==n.userToken&&(s["X-Token"]=n.userToken.toString());const e=null!==(r=n.clientAgent)&&void 0!==r?r:n.userAgent;void 0!==e&&(s["X-Client-Agent"]=e),void 0!==n.context&&(a.context=n.context),void 0!==n.previewToken&&(a.previewToken=`${n.previewToken}`)}return fetch(c?this.dynamicEndpoint:this.staticEndpoint,{credentials:"omit",...n.extra,method:"POST",headers:s,signal:t,body:JSON.stringify(a)})}static isDynamicContent(e){return!0!==e.static}toJSON(){throw new Error("Unserializable value.")}}Qn.ContentFetcher=Yn,Object.defineProperty(He,"__esModule",{value:!0}),He.Container=void 0;const Zn=et,Hn=ct,er=wt,tr=kt,nr=Mt,rr=De,ir=zt,or=Wt,sr=un,ar=dn,cr=lt,ur=wn,lr=Cn,dr=jn,hr=Qn;He.Container=class{constructor(e){this.eventManager=new cr.SynchronousEventManager,this.configuration=e}getConfiguration(){return this.configuration}getEvaluator(){return void 0===this.evaluator&&(this.evaluator=this.createEvaluator()),this.evaluator}createEvaluator(){return new or.Evaluator({appId:this.configuration.appId,baseEndpointUrl:this.configuration.evaluationBaseEndpointUrl,logger:this.getLogger("Evaluator")})}getContentFetcher(){return void 0===this.contentFetcher&&(this.contentFetcher=this.createContentFetcher()),this.contentFetcher}createContentFetcher(){return new hr.ContentFetcher({appId:this.configuration.appId,baseEndpointUrl:this.configuration.contentBaseEndpointUrl,logger:this.getLogger("ContentFetcher")})}getPreviewTokenStore(){return void 0===this.previewTokenStore&&(this.previewTokenStore=new rr.CachedTokenStore(new ur.LocalStorageCache(this.getGlobalBrowserStorage("preview"),"token"))),this.previewTokenStore}getTracker(){return void 0===this.tracker&&(this.tracker=this.createTracker()),this.tracker}createTracker(){const e=this.getContext(),t=new ir.Tracker({tab:e.getTab(),tokenProvider:this.getUserTokenStore(),inactivityRetryPolicy:new tr.ArbitraryPolicy([3e4,3e4,12e4,12e4,3e5,3e5,9e5]),logger:this.getLogger("Tracker"),channel:this.getBeaconChannel(),eventMetadata:this.configuration.eventMetadata}),n=this.getBeaconQueue();return n.addCallback("halfEmpty",t.unsuspend),n.addCallback("full",t.suspend),t}getUserTokenStore(){if(void 0===this.userTokenProvider){const e=this.getContext();this.userTokenProvider={getToken:e.getToken.bind(e),setToken:e.setToken.bind(e)}}return this.userTokenProvider}getContext(){return void 0===this.context&&(this.context=this.createContext()),this.context}createContext(){const e=this.resolveStorageNamespace("token"),t=this.resolveStorageNamespace("tab"),n=this.getLocalStorage(),r=new ur.LocalStorageCache(n,e),i=this.getSessionStorage();return this.removeTokenSyncListener=ur.LocalStorageCache.autoSync(r),Hn.Context.load({tokenScope:this.configuration.tokenScope,eventDispatcher:this.getEventManager(),urlSanitizer:this.configuration.urlSanitizer,cache:{tabId:new ur.LocalStorageCache(i,t),tabToken:new ur.LocalStorageCache(i,e),browserToken:r}})}getBeaconChannel(){return void 0===this.beaconChannel&&(this.beaconChannel=this.createBeaconChannel()),this.beaconChannel}createBeaconChannel(){if(this.configuration.test)return new dr.SandboxChannel;const e=this.getLogger("BeaconChannel"),{appId:t,trackerEndpointUrl:n}=this.configuration,r=new dr.QueuedChannel(new dr.RetryChannel({channel:new dr.GuaranteedChannel({channel:new dr.BeaconSocketChannel({trackerEndpointUrl:`${n}/${t}`,tokenParameter:"token",loggerFactory:this.getLogger.bind(this),logger:e,channelFactory:(e,t)=>new dr.SocketChannel({url:e,logger:t}),cidAssigner:this.getCidAssigner(),cidParameter:"clientId"}),stamper:new lr.TimeStamper,ackTimeout:1e4,logger:e}),retryPolicy:new tr.BackoffPolicy({minRetryDelay:1e3,maxRetryDelay:6e4,backoffFactor:1.5,backoffJitter:1}),logger:e}),this.getBeaconQueue(),e);return r.flush().catch((()=>{})),new dr.EncodedChannel(r,sr.encodeJson)}getCidAssigner(){return void 0===this.cidAssigner&&(this.cidAssigner=this.createCidAssigner()),this.cidAssigner}createCidAssigner(){if(void 0!==this.configuration.clientId)return new ar.FixedAssigner(this.configuration.clientId);if(this.configuration.test)return new ar.FixedAssigner("00000000-0000-0000-0000-000000000000");const e=this.getLogger("CidAssigner");return new ar.CachedAssigner(new ar.RemoteAssigner(this.configuration.cidAssignerEndpointUrl,e),new ur.LocalStorageCache(this.getLocalStorage(),"croct.cid"),{logger:e,mirror:!this.configuration.disableCidMirroring})}getBeaconQueue(){return void 0===this.beaconQueue&&(this.beaconQueue=this.createBeaconQueue()),this.beaconQueue}createBeaconQueue(){const e=this.getContext().getTab();return new nr.MonitoredQueue(new nr.CapacityRestrictedQueue(new nr.PersistentQueue(this.getGlobalTabStorage("queue"),e.id),this.configuration.beaconQueueSize),this.getLogger("BeaconQueue"))}getLogger(...e){const t="Croct"+(0===e.length?"":`:${e.join(":")}`);return void 0!==this.configuration.logger?new Zn.NamespacedLogger(this.configuration.logger,t):this.configuration.debug?new Zn.ConsoleLogger(t):new Zn.NullLogger}getTabStorage(e,...t){return this.getGlobalTabStorage("external",e,...t)}getBrowserStorage(e,...t){return this.getGlobalBrowserStorage("external",e,...t)}getGlobalTabStorage(e,...t){return new er.NamespacedStorage(this.getSessionStorage(),this.resolveStorageNamespace(e,...t))}getGlobalBrowserStorage(e,...t){return new er.NamespacedStorage(this.getLocalStorage(),this.resolveStorageNamespace(e,...t))}resolveStorageNamespace(e,...t){return`croct[${this.configuration.appId.toLowerCase()}].${[e].concat(t).join(".")}`}getLocalStorage(){return localStorage}getSessionStorage(){return sessionStorage}getEventManager(){return this.eventManager}async dispose(){const e=this.getLogger();void 0!==this.beaconChannel&&(e.debug("Closing beacon channel..."),await this.beaconChannel.close()),void 0!==this.removeTokenSyncListener&&(e.debug("Removing token sync listener..."),this.removeTokenSyncListener()),void 0!==this.tracker&&(void 0!==this.beaconQueue&&(e.debug("Removing queue listeners..."),this.beaconQueue.removeCallback("halfEmpty",this.tracker.unsuspend),this.beaconQueue.removeCallback("full",this.tracker.suspend)),e.debug("Suspending tracker..."),this.tracker.suspend(),await this.tracker.flushed),delete this.context,delete this.userTokenProvider,delete this.previewTokenStore,delete this.cidAssigner,delete this.tracker,delete this.evaluator,delete this.contentFetcher,delete this.beaconChannel,delete this.beaconQueue,delete this.removeTokenSyncListener,e.debug("Container resources released.")}},Object.defineProperty(Ze,"__esModule",{value:!0}),Ze.Sdk=void 0;const pr=He,gr=Yt,yr=r,mr=we;class fr{constructor(e){this.container=e}static init(e){var t;!function(e){if("object"!=typeof e||null===e)throw new Error("The configuration must be a key-value map.");try{yr.sdkConfigurationSchema.validate(e)}catch(e){throw new Error(`Invalid configuration: ${(0,mr.formatCause)(e)}`)}}(e);const{disableCidMirroring:n,eventMetadata:r={},baseEndpointUrl:i=gr.BASE_ENDPOINT_URL,cidAssignerEndpointUrl:o,...s}=e,a={sdkVersion:gr.VERSION};for(const e of Object.keys(r))a[`custom_${e}`]=r[e];const c=i.replace(/\/+$/,""),u=c.replace(/^http/i,"ws"),l=new pr.Container({...s,disableCidMirroring:n,evaluationBaseEndpointUrl:c,contentBaseEndpointUrl:c,trackerEndpointUrl:`${u}/client/web/connect`,cidAssignerEndpointUrl:null!=o?o:`${c}/client/web/cid`,beaconQueueSize:null!==(t=s.beaconQueueSize)&&void 0!==t?t:100,eventMetadata:a}),d=l.getLogger(),{appId:h,tokenScope:p}=l.getConfiguration();d.debug("\n\n ██████ ██████   ██████   ██████ ████████ \n██      ██   ██ ██    ██ ██         ██    \n██      ██████  ██    ██ ██         ██    \n██      ██   ██ ██    ██ ██         ██    \n ██████ ██   ██  ██████   ██████    ██    \n\n"),d.info(`Initializing SDK v${gr.VERSION}...`),d.debug(`App ID: ${h}`);const g=l.getContext(),y=g.getTab(),m=g.getUser();return d.debug(`${y.isNew?"New":"Current"} tab: ${y.id}`),d.debug(`Token scope: ${p}`),d.debug(`Current user: ${null!==m?m:"anonymous"}`),d.debug(`Test mode: ${s.test}`),d.info("⚡ Croct SDK is ready!"),new fr(l)}get appId(){const{appId:e}=this.container.getConfiguration();return e}get cidAssigner(){return this.container.getCidAssigner()}get previewTokenStore(){return this.container.getPreviewTokenStore()}get userTokenStore(){return this.container.getUserTokenStore()}get context(){return this.container.getContext()}get tracker(){return this.container.getTracker()}get evaluator(){return this.container.getEvaluator()}get contentFetcher(){return this.container.getContentFetcher()}get eventManager(){return this.container.getEventManager()}getLogger(...e){return this.container.getLogger(...e)}getTabStorage(e,...t){return this.container.getTabStorage(e,...t)}getBrowserStorage(e,...t){return this.container.getBrowserStorage(e,...t)}async close(){if(this.closed)return;const e=this.getLogger();e.debug("Closing SDK..."),this.closed=!0,await this.container.dispose(),e.info("SDK closed.")}}Ze.Sdk=fr;var vr={},br={};Object.defineProperty(br,"__esModule",{value:!0}),br.SessionPatch=void 0;const wr=Me;class Tr extends wr.ActiveRecord{constructor(e){super(),this.tracker=e}save(){if(!this.isDirty())return Promise.resolve({type:"sessionAttributesChanged",patch:{operations:[]}});const e=this.tracker.track({type:"sessionAttributesChanged",patch:this.buildPatch()});return this.reset(),e}}br.SessionPatch=Tr,Object.defineProperty(vr,"__esModule",{value:!0}),vr.SessionFacade=void 0;const kr=br;vr.SessionFacade=class{constructor(e){this.tracker=e}edit(){return new kr.SessionPatch(this.tracker)}};var Sr={};Object.defineProperty(Sr,"__esModule",{value:!0}),Sr.ContentFetcherFacade=void 0;const Pr=we,Or=r;Sr.ContentFetcherFacade=class{constructor(e){this.fetcher=e.contentFetcher,this.previewTokenProvider=e.previewTokenProvider,this.userTokenProvider=e.userTokenProvider,this.cidAssigner=e.cidAssigner,this.contextFactory=e.contextFactory}async fetch(e,t={}){var n,r;if("string"!=typeof e||0===e.length)throw new Error("The slot ID must be a non-empty string.");return function(e){try{Or.fetchOptionsSchema.validate(e)}catch(e){throw new Error(`Invalid options: ${(0,Pr.formatCause)(e)}`)}}(t),this.fetcher.fetch(e,{static:!1,clientId:await this.cidAssigner.assignCid(),userToken:null!==(n=this.userTokenProvider.getToken())&&void 0!==n?n:void 0,previewToken:null!==(r=this.previewTokenProvider.getToken())&&void 0!==r?r:void 0,version:t.version,preferredLocale:t.preferredLocale,context:this.contextFactory.createContext(t.attributes),timeout:t.timeout})}},Object.defineProperty(t,"__esModule",{value:!0});var _r=t.SdkFacade=void 0;const Er=n,Cr=_e,xr=je,Lr=De,jr=we,Ir=r,Mr=Ze,Nr=vr,Ar=Sr;class $r{constructor(e){this.sdk=e}static init(e){var t,n,r,i;!function(e){try{Ir.sdkFacadeConfigurationSchema.validate(e)}catch(e){throw new Error(`Invalid configuration: ${(0,jr.formatCause)(e)}`)}}(e);const{track:o=!0,userId:s,token:a,...c}=e;if(void 0!==s&&void 0!==a)throw new Error("Either the user ID or token can be specified, but not both.");const u=new $r(Mr.Sdk.init({...c,tokenScope:null!==(t=c.tokenScope)&&void 0!==t?t:"global",debug:null!==(n=c.debug)&&void 0!==n&&n,test:null!==(r=c.test)&&void 0!==r&&r,disableCidMirroring:null!==(i=c.disableCidMirroring)&&void 0!==i&&i}));if(void 0!==s)if(null===s)u.unsetToken();else{const e=u.context.getToken();(null==e?void 0:e.getSubject())!==s&&u.identify(s)}else void 0!==a&&(null===a?u.unsetToken():u.setToken(Lr.Token.parse(a)));return o&&u.tracker.enable(),u}get context(){return this.sdk.context}get cidAssigner(){return this.sdk.cidAssigner}get previewTokenStore(){return this.sdk.previewTokenStore}get userTokenStore(){return this.sdk.userTokenStore}get tracker(){return void 0===this.trackerFacade&&(this.trackerFacade=new Cr.TrackerFacade(this.sdk.tracker)),this.trackerFacade}get user(){return void 0===this.userFacade&&(this.userFacade=new xr.UserFacade(this.context,this.sdk.tracker)),this.userFacade}get session(){return void 0===this.sessionFacade&&(this.sessionFacade=new Nr.SessionFacade(this.sdk.tracker)),this.sessionFacade}get evaluator(){return void 0===this.evaluatorFacade&&(this.evaluatorFacade=new Er.EvaluatorFacade({evaluator:this.sdk.evaluator,contextFactory:new Er.TabContextFactory(this.sdk.context.getTab()),cidAssigner:this.sdk.cidAssigner,userTokenProvider:this.sdk.userTokenStore})),this.evaluatorFacade}get contentFetcher(){return void 0===this.contentFetcherFacade&&(this.contentFetcherFacade=new Ar.ContentFetcherFacade({contentFetcher:this.sdk.contentFetcher,contextFactory:new Er.TabContextFactory(this.sdk.context.getTab()),cidAssigner:this.sdk.cidAssigner,previewTokenProvider:this.sdk.previewTokenStore,userTokenProvider:this.sdk.userTokenStore})),this.contentFetcherFacade}get eventManager(){const{eventManager:e}=this.sdk;return{addListener:e.addListener.bind(e),removeListener:e.removeListener.bind(e),dispatch:(t,n)=>{if(!/[a-z][a-z_]+\.[a-z][a-z_]+/i.test(t))throw new Error('The event name must be in the form of "namespaced.eventName", where both the namespace and event name must start with a letter, followed by any series of letters and underscores.');e.dispatch(t,n)}}}identify(e){this.setToken(Lr.Token.issue(this.sdk.appId,e))}anonymize(){this.context.isAnonymous()||this.unsetToken()}getToken(){return this.context.getToken()}setToken(e){var t;const n=this.getToken();if(null!==n&&n.toString()===e.toString())return;const r=null!==(t=null==n?void 0:n.getSubject())&&void 0!==t?t:null,i=e.getSubject(),o=this.getLogger();if(i===r)return this.context.setToken(e),void o.debug("Token refreshed");null!==r&&(this.trackInternalEvent({type:"userSignedOut",userId:r}),o.info("User signed out")),this.context.setToken(e),null!==i&&(this.trackInternalEvent({type:"userSignedIn",userId:i}),o.info(`User signed in as ${i}`)),o.debug("New token saved, ")}unsetToken(){const e=this.getToken();if(null===e)return;const t=this.getLogger(),n=e.getSubject();null!==n&&(this.trackInternalEvent({type:"userSignedOut",userId:n}),t.info("User signed out")),this.context.setToken(null),t.debug("Token removed")}trackInternalEvent(e){this.sdk.tracker.track(e).catch((()=>{}))}getLogger(...e){return this.sdk.getLogger(...e)}getTabStorage(e,...t){return this.sdk.getTabStorage(e,...t)}getBrowserStorage(e,...t){return this.sdk.getBrowserStorage(e,...t)}close(){return this.sdk.close()}}_r=t.SdkFacade=$r;var Ur={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.VERSION=e.Sdk=void 0;const t=Yt;Object.defineProperty(e,"VERSION",{enumerable:!0,get:function(){return t.VERSION}});const n=Ze;Object.defineProperty(e,"Sdk",{enumerable:!0,get:function(){return n.Sdk}})}(Ur);const Fr="https://play.croct.com";class Rr{constructor(e){this.sdkVersion=e.sdkVersion,this.appId=e.appId,this.connectionId=e.connectionId,this.tab=e.tab,this.contextFactory=e.contextFactory,this.storage=e.storage,this.eventSubscriber=e.eventSubscriber,this.cidAssigner=e.cidAssigner,this.tokenProvider=e.tokenProvider,this.logger=e.logger}enable(){const e=this.resolveConnectionId();if(null!==e)return this.syncListener=()=>this.cidAssigner.assignCid().then((t=>{this.syncToken(e,t)})).catch((e=>{this.logger.warn(`Sync failed: ${Te(e)}`)})),this.eventSubscriber.addListener("tokenChanged",this.syncListener),this.tab.addListener("urlChange",this.syncListener),this.syncListener()}resolveConnectionId(){if(void 0!==this.connectionId)return this.logger.debug("Connection ID passed in configuration"),this.connectionId;let e=new URL(this.tab.url).searchParams.get("__cplay");return null===e||""===e?(this.logger.debug("No connection ID found in URL"),e=this.storage.getItem("connectionId"),this.logger.debug(null!==e?"Previous connection ID found":"No previous connection ID found"),e):(this.logger.debug("Connection ID found in URL"),this.storage.setItem("connectionId",e),e)}disable(){void 0!==this.syncListener&&(this.eventSubscriber.removeListener("tokenChanged",this.syncListener),this.tab.removeListener("urlChange",this.syncListener),delete this.syncListener)}syncToken(e,t){const n=document.createElement("iframe");n.setAttribute("src","https://play.croct.com/connect.html"),n.setAttribute("sandbox","allow-scripts allow-same-origin"),n.style.visibility="hidden",n.style.opacity="0",n.style.border="0",n.style.width="0",n.style.height="0";const r=this.createContext();n.onload=()=>{var i,o;if(null===n.contentWindow)return document.body.contains(n)&&document.body.removeChild(n),void this.logger.warn("Sync handshake failed");const s=t=>{t.origin===Fr&&t.data===e&&(window.removeEventListener("message",s),document.body.contains(n)&&document.body.removeChild(n),this.logger.debug("Sync completed"))};window.addEventListener("message",s);const a={appId:this.appId,connectionId:e,sdkVersion:this.sdkVersion,tabId:this.tab.id,cid:t,token:null!==(o=null===(i=this.tokenProvider.getToken())||void 0===i?void 0:i.toString())&&void 0!==o?o:null,context:r};n.contentWindow.postMessage(a,Fr),this.logger.debug("Waiting for sync acknowledgment...")},this.logger.debug("Sync started");const i=()=>{document.body.appendChild(n)};null===document.body?document.addEventListener("DOMContentLoaded",i):i()}createContext(){const{page:e,campaign:t,timeZone:n}=this.contextFactory.createContext(),r={};return void 0!==e&&(r.page=e),void 0!==t&&(r.campaign=t),void 0!==n&&(r.timeZone=n),r}}const qr=e=>{const{sdk:t,options:n}=e;return new Rr({sdkVersion:t.version,appId:t.appId,connectionId:n.connectionId,tab:t.tab,storage:t.getTabStorage(),tokenProvider:t.userTokenStore,cidAssigner:t.cidAssigner,contextFactory:new Se(t.tab),eventSubscriber:t.eventManager,logger:t.getLogger()})},Dr="croct-preview",Vr="exit";class Br{constructor(e){this.cleanUp=[],this.tokenStore=e.tokenStore,this.logger=e.logger}enable(){const e=new URL(window.location.href).searchParams.get(Dr);null!==e&&(this.updateToken(e),this.updateUrl(),setTimeout(this.updateUrl,500));const t=this.tokenStore.getToken();null!==t&&this.insertWidget(this.getWidgetUrl(t))}disable(){this.cleanUp.splice(0).forEach((e=>e()))}updateToken(e){if(e===Vr)return this.logger.debug("Exiting preview mode."),void this.tokenStore.setToken(null);try{let t=De.Token.parse(e);const{exp:n}=t.getPayload();void 0!==n&&n<=Date.now()/1e3&&(this.logger.debug("Preview token expired."),t=null),this.logger.debug("Preview token updated."),this.tokenStore.setToken(t)}catch(e){this.tokenStore.setToken(null),this.logger.warn(`Invalid preview token: ${Te(e)}`)}}getWidgetUrl(e){let t=this.getWidgetParams(e).toString();return""!==t&&(t=`?${t}`),`https://cdn.croct.io/js/v1/lib/plug/widget-0.13.3.html${t}`}getWidgetParams(e){const{metadata:t={}}=e.getPayload(),n=new URLSearchParams;if(null===t||"object"!=typeof t||Array.isArray(t))return n;for(const[e,r]of Object.entries(Br.PREVIEW_PARAMS)){const i=t[e];"string"==typeof i&&n.set(r,i)}return n}insertWidget(e){const t=this.createWidget(e),n=e=>{if("https://cdn.croct.io"===e.origin)switch(e.data.type){case"croct:preview:leave":{this.tokenStore.setToken(null);const e=new URL(window.location.href);e.searchParams.set(Dr,Vr),window.location.replace(e.toString());break}case"croct:preview:resize":t.style.width=`${e.data.width}px`,t.style.height=`${e.data.height}px`}};window.addEventListener("message",n),this.cleanUp.push((()=>window.removeEventListener("message",n)));const r=()=>{const e=document.body;e.prepend(t),this.cleanUp.push((()=>e.removeChild(t))),this.logger.debug("Preview widget mounted.");const n=new MutationObserver((()=>{e.contains(t)||(e.prepend(t),this.logger.debug("Preview widget removed from DOM, reinserting."))}));n.observe(e,{childList:!0}),this.cleanUp.unshift((()=>n.disconnect()))};"loading"!==document.readyState?r():(this.logger.debug("Waiting for document to be ready."),this.cleanUp.push((()=>window.removeEventListener("DOMContentLoaded",r))),window.addEventListener("DOMContentLoaded",r))}updateUrl(){const e=new URL(window.location.href);e.searchParams.has(Dr)&&(e.searchParams.delete(Dr),window.history.replaceState({},"",e.toString()))}createWidget(e){const t=document.createElement("iframe");return t.setAttribute("src",e),t.setAttribute("sandbox","allow-scripts allow-same-origin"),t.style.position="fixed",t.style.width="0px",t.style.height="0px",t.style.right="0",t.style.bottom="0",t.style.border="0",t.style.overflow="hidden",t.style.zIndex="2147483647",t}}Br.PREVIEW_PARAMS={experienceName:"experience",experimentName:"experiment",audienceName:"audience",variantName:"variant"};const zr=e=>{const{sdk:t}=e;return new Br({tokenStore:e.sdk.previewTokenStore,logger:t.getLogger()})},Qr="Plugin";var Jr=new class{constructor(){this.pluginFactories={playground:qr,preview:zr},this.plugins={},this.ready=new Promise((e=>{this.initialize=e}))}extend(e,t){if(void 0!==this.pluginFactories[e])throw new Error(`Another plugin is already registered with name "${e}".`);this.pluginFactories[e]=t}plug(e={}){var t,n,r,i;if(void 0!==this.instance){return void this.instance.getLogger().info("Croct is already plugged in.")}const o=function(){const e=window.document.querySelector("script[src^='https://cdn.croct.io/js/v1/lib/plug.js']");return e instanceof HTMLScriptElement?new URL(e.src).searchParams.get("appId"):null}(),s=null!==(t=e.appId)&&void 0!==t?t:null;if(null!==o&&null!==s&&o!==s)throw new Error('The specified app ID and the auto-detected app ID are conflicting. There is no need to specify an app ID when using an application-specific tag. Please try again omitting the "appId" option.');const a=null!=o?o:s;if(null===a)throw new Error('The app ID must be specified when it cannot be auto-detected. Please try again specifying the "appId" option.');const{plugins:c,test:u,...l}=e,d=_r.init({...l,appId:a,test:null!=u?u:"object"==typeof process&&(void 0!==(null===(n=process.env)||void 0===n?void 0:n.CROCT_TEST_MODE)?"true"===process.env.CROCT_TEST_MODE:"test"===(null===(r=process.env)||void 0===r?void 0:r.NODE_ENV))});this.instance=d;const h=this.instance.getLogger();o===s&&h.warn('It is strongly recommended omitting the "appId" option when using the application-specific tag as it is detected automatically.');const p=[],g=Object.fromEntries(Object.keys(this.pluginFactories).map((e=>[e,!0])));for(const[e,t]of Object.entries({...g,...c})){h.debug(`Initializing plugin "${e}"...`);const n=this.pluginFactories[e];if(void 0===n){h.error(`Plugin "${e}" is not registered.`);continue}if("boolean"!=typeof t&&(null===t||"object"!=typeof t)){h.error(`Invalid options for plugin "${e}", expected either boolean or object but got ${y.describe(t)}`);continue}if(!1===t){h.warn(`Plugin "${e}" is declared but not enabled`);continue}const r={options:!0===t?{}:t,sdk:{version:Ur.VERSION,appId:a,tracker:d.tracker,evaluator:d.evaluator,user:d.user,session:d.session,tab:d.context.getTab(),userTokenStore:{getToken:d.getToken.bind(d),setToken:d.setToken.bind(d)},previewTokenStore:d.previewTokenStore,cidAssigner:d.cidAssigner,eventManager:d.eventManager,getLogger:(...t)=>d.getLogger(Qr,e,...t),getTabStorage:(...t)=>d.getTabStorage(Qr,e,...t),getBrowserStorage:(...t)=>d.getBrowserStorage(Qr,e,...t)}};let i;try{i=n(r)}catch(t){h.error(`Failed to initialize plugin "${e}": ${Te(t)}`);continue}if(h.debug(`Plugin "${e}" initialized`),"object"!=typeof i)continue;this.plugins[e]=i;const o=i.enable();o instanceof Promise?p.push(o.then((()=>h.debug(`Plugin "${e}" enabled`))).catch((t=>h.error(`Failed to enable plugin "${e}": ${Te(t)}`)))):h.debug(`Plugin "${e}" enabled`)}const m=null===(i=window.croctEap)||void 0===i?void 0:i.initialize;"function"==typeof m&&m.call(this),Promise.all(p).then((()=>{this.initialize(),h.debug("Initialization complete")}))}get initialized(){return void 0!==this.instance}get plugged(){return this.ready.then((()=>this))}get flushed(){return this.tracker.flushed.then((()=>this))}get sdk(){if(void 0===this.instance)throw new Error("Croct is not plugged in.");return this.instance}get tracker(){return this.sdk.tracker}get evaluator(){return this.sdk.evaluator}get user(){return this.sdk.user}get session(){return this.sdk.session}isAnonymous(){return this.sdk.context.isAnonymous()}getUserId(){return this.sdk.context.getUser()}identify(e){if("string"!=typeof e)throw new Error("The user ID must be a string. Read more on https://croct.help/plug-js/id-conversion");this.sdk.identify(e)}anonymize(){this.sdk.anonymize()}setToken(e){this.sdk.setToken(De.Token.parse(e))}unsetToken(){this.sdk.unsetToken()}track(e,t){return this.sdk.tracker.track(e,t)}evaluate(e,t={}){return this.sdk.evaluator.evaluate(e,t)}test(e,t={}){return this.evaluate(e,t).then((e=>!0===e))}get fetch(){return this.eap("fetch",((e,t={})=>{const[n,r="latest"]=e.split("@"),i=this.sdk.getLogger();return this.sdk.contentFetcher.fetch(n,"latest"===r?t:{...t,version:r}).then((e=>({get payload(){return i.warn('Accessing the "payload" property of the fetch response is deprecated and will be removed in a future version. Use the "content" property instead.'),e.content},content:e.content})))}))}async unplug(){if(void 0===this.instance)return;const{instance:e,plugins:t}=this,n=this.sdk.getLogger(),r=[];for(const[e,i]of Object.entries(t)){if("function"!=typeof i.disable)continue;n.debug(`Disabling plugin "${e}"...`);const t=i.disable();t instanceof Promise?r.push(t.then((()=>n.debug(`Plugin "${e}" disabled`))).catch((t=>n.error(`Failed to disable "${e}": ${Te(t)}`)))):n.debug(`Plugin "${e}" disabled`)}delete this.instance,this.plugins={},this.ready=new Promise((e=>{this.initialize=e})),await Promise.all(r);try{await e.close()}finally{n.info("🔌 Croct has been unplugged.")}}eap(e,t){const n=window.croctEap,r="object"==typeof n?n[e]:void 0;return"function"!=typeof r?t:r.bind(new Proxy(this,{get:(n,r)=>r===e?t:n[r]}))}};return Jr}();
